<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>三劍客台指期策略分析（單檔｜含 Risk-Return 面板）</title>
  <!-- 圖表套件 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- 字體（可選） -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb; --text:#0f172a;
      --card:#ffffff; --border:#e5e7eb;
      --muted:#64748b; --muted2:#94a3b8;
      --accent:#0ea5e9; --good:#16a34a; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1200px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 16px;font-size:22px;font-weight:800}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    .btn{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#f3f4f6}
    textarea{width:100%;min-height:140px;padding:10px;border:1px solid var(--border);border-radius:10px;
             background:#fff;color:var(--text);font-family:ui-monospace,Consolas,Menlo,monospace}
    .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:12px}
    .two-col{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
    @media (max-width:1000px){.two-col{grid-template-columns:1fr}}
    .kpi{background:#fafafa;border:1px solid var(--border);border-radius:10px;padding:12px}
    .kpi h3{margin:0 0 6px;font-size:12px;color:var(--muted)}
    .kpi .val{font-size:18px;font-weight:800}
    table{width:100%;border-collapse:collapse}
    th,td{font-size:12px;padding:8px 10px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{position:sticky;top:0;background:#f9fafb}
    .section-title{font-weight:800;margin:6px 0 10px}
  </style>
</head>
<body>
  <div class="container">
    <h1>三劍客台指期策略分析（單檔）</h1>

    <!-- 上傳/貼上 -->
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="margin-bottom:8px">
        <button id="pasteBtn" class="btn">貼上內容</button>
        <input id="fileInput" type="file" accept=".txt" class="btn" />
        <span class="muted">支援：貼上策略輸出的 TXT 或直接上傳檔案（需有 日期/時間 與 損益 或 點數）。</span>
      </div>
      <textarea id="raw" placeholder="貼上 TXT 內容..."></textarea>
      <div class="row" style="margin-top:8px">
        <button id="runBtn" class="btn">解析並繪圖</button>
        <span class="muted">風險資本(NAV)：</span>
        <input id="navInput" type="number" value="1000000" style="width:140px;padding:6px;border:1px solid var(--border);border-radius:8px">
        <span class="muted">元；無風險利率 rf(年化)：</span>
        <input id="rfInput" type="number" step="0.001" value="0.00" style="width:90px;padding:6px;border:1px solid var(--border);border-radius:8px">
      </div>
    </div>

    <!-- 圖表 + 基礎 KPI -->
    <div class="two-col" style="margin-bottom:12px">
      <div class="card"><canvas id="equityChart" height="240"></canvas></div>
      <div class="card">
        <div class="section-title">概覽（基礎）</div>
        <div id="basicSummary" class="grid" style="grid-template-columns:repeat(2,1fr)"></div>
      </div>
    </div>

    <!-- ★ Risk-Return 面板：插在圖表與交易明細中間 ★ -->
    <div id="rr-panel" class="card" style="margin-bottom:12px">
      <div class="section-title">Risk-Return 指標</div>
      <div id="rr-grid" class="grid" style="grid-template-columns:repeat(6,1fr)"></div>
      <div class="muted" style="margin-top:6px">Sharpe/Sortino/MAR 以「日聚合報酬序列」計算；VaR/ES 為歷史模擬法。</div>
    </div>

    <!-- 交易明細 -->
    <div class="card">
      <div class="section-title">交易明細</div>
      <div style="overflow:auto;max-height:520px">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th><th>日期</th><th>時間</th><th>方向</th><th>口數</th>
              <th>進場價</th><th>出場價</th><th>點數</th><th>損益</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ---------- 工具 ----------
    const fmt = n => Math.abs(n)>=1e6 ? (n/1e6).toFixed(2)+'M'
                 : Math.abs(n)>=1e3 ? (n/1e3).toFixed(1)+'k'
                 : (Math.round(n)).toLocaleString();
    const pct = x => (x*100).toFixed(2)+'%';
    const avg = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;
    const stdev = a => { if(a.length<2) return 0; const m=avg(a); return Math.sqrt(a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1)); };

    // ---------- 解析 TXT ----------
    function parseText(raw){
      const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(!lines.length) return { trades:[], daily:[] };

      // 偵測 CSV/TSV
      const sep = lines[0].includes('\t') ? '\t' : ',';
      let headers = lines[0].split(new RegExp(sep)).map(h=>h.trim());
      const looksTable = headers.some(h => /日期|time|date|進場時間|出場時間|損益|profit|點數/i.test(h));

      let rows=[];
      if(looksTable){
        for(let i=1;i<lines.length;i++){
          const arr = lines[i].split(new RegExp(sep)).map(s=>s.trim());
          if(arr.length<2) continue;
          rows.push(Object.fromEntries(arr.map((v,idx)=>[headers[idx]||('c'+idx),v])));
        }
      }else{
        rows = lines.map(l=>{
          const p=l.split(/[\s,]+/).filter(Boolean);
          return { c0:p[0], c1:p[1], c2:p[2], c3:p[3] };
        });
      }

      const trades=[];
      for(const r of rows){
        const date = pick(r,[/^日期$/i,/date/i]);
        const time = pick(r,[/^時間$/i,/time/i,/進場時間/i]);
        const dir  = pick(r,[/^方向$/i,/side/i,/type/i]);
        const qty  = +(pick(r,[/口數/,/qty/i])||1);
        const inPx = toNum(pick(r,[/進場價/,/entry/i]));
        const outPx= toNum(pick(r,[/出場價/,/exit/i]));
        const pts  = toNum(pick(r,[/^點數$/, /points?/i]));
        const pnl  = toNum(pick(r,[/^損益$/, /^獲利$/, /pnl/i, /profit/i]));
        const when = parseWhen(date, time);
        const pointValue = 200; // 台指期點值，可改
        const pnlUse = Number.isFinite(pnl) ? pnl : (Number.isFinite(pts) ? pts*pointValue*qty : NaN);
        if(!when || !Number.isFinite(pnlUse)) continue;
        trades.push({ when, date:when.toISOString().slice(0,10), time:when.toTimeString().slice(0,8), dir, qty, inPx, outPx, pts, pnl:pnlUse });
      }

      // 轉成「日損益」
      const dailyMap = new Map();
      for(const t of trades){ dailyMap.set(t.date, (dailyMap.get(t.date)||0) + t.pnl); }
      const daily = [...dailyMap.entries()].sort((a,b)=>a[0].localeCompare(b[0])).map(([d,v])=>({date:d,pnl:v}));

      return { trades, daily };

      function pick(obj, regs){ for(const k of Object.keys(obj)){ if(regs.some(re=>re.test(k))) return obj[k]; } }
      function toNum(v){ const n=parseFloat(String(v||'').replace(/[^\-\d\.]/g,'')); return Number.isFinite(n)?n:NaN; }
      function parseWhen(d,t){
        if(!d && !t) return null;
        let s=''; if(d) s+=String(d).replace(/\D/g,'');
        if(t) s+='T'+String(t).replace(/\D/g,'').padEnd(6,'0').replace(/(\d{2})(\d{2})(\d{2}).*/,'$1:$2:$3');
        if(/\d{8}T\d{2}:\d{2}:\d{2}/.test(s)){ const iso=s.replace(/(\d{4})(\d{2})(\d{2})T/,'$1-$2-$3T'); return new Date(iso); }
        return null;
      }
    }

    // ---------- KPI（用日損益序列） ----------
    function computeRiskReturnKPI(daily, nav=1_000_000, rf=0){
      // 權益曲線 & MDD/TUW
      let cum=0;
      const eq = daily.map(d => ({date:d.date, nav:(cum+=d.pnl, nav+cum)}));
      let peak=-Infinity, maxDD=0, ddStart=null, ddEnd=null, curPeak=null, TUW=0, maxTUW=0;
      for(const p of eq){
        if(p.nav>peak){ peak=p.nav; curPeak=p.date; TUW=0; }
        else{ const dd=peak-p.nav; if(dd>maxDD){ maxDD=dd; ddStart=curPeak; ddEnd=p.date; } TUW++; if(TUW>maxTUW) maxTUW=TUW; }
      }

      // 日報酬（資本回報）
      const dailyRet = daily.map(d=> d.pnl/nav);
      const mean = avg(dailyRet);
      const vol = stdev(dailyRet)*Math.sqrt(252);
      const downside = stdev(dailyRet.filter(x=>x<(rf/252)))*Math.sqrt(252);

      // 年化、Sharpe/Sortino/MAR
      const totalPnL = daily.reduce((a,b)=>a+b.pnl,0);
      const years = daily.length ? Math.max(daily.length/252, 1/365) : 1/365;
      const CAGR = Math.pow((nav+totalPnL)/nav, 1/years)-1;
      const sharpe = vol>0 ? ((mean*252 - rf)/vol) : 0;
      const sortino = downside>0 ? ((mean*252 - rf)/downside) : 0;
      const MAR = maxDD>0 ? (CAGR/(maxDD/nav)) : 0;

      // VaR / ES
      const q=(arr,p)=>{ const a=[...arr].sort((x,y)=>x-y); const i=Math.max(0,Math.min(a.length-1,Math.floor((1-p)*a.length))); return a[i]; };
      const ES=(arr,p)=>{ const a=[...arr].sort((x,y)=>x-y); const cut=Math.floor((1-p)*a.length); const sl=a.slice(0,cut); return sl.length? -(sl.reduce((x,y)=>x+y,0)/sl.length)*nav : 0; };
      const VaR95= -q(dailyRet,0.95)*nav, VaR99=-q(dailyRet,0.99)*nav;
      const ES95 = ES(dailyRet,0.95), ES99 = ES(dailyRet,0.99);

      return { totalPnL, CAGR, sharpe, sortino, MAR, maxDD, ddStart, ddEnd, maxTUW, VaR95, VaR99, ES95, ES99, eq };
    }

    // ---------- 畫面渲染 ----------
    let chart;
    function renderEquity(eq){
      chart && chart.destroy();
      chart = new Chart(document.getElementById('equityChart'), {
        type:'line',
        data:{ labels:eq.map(x=>x.date),
               datasets:[{label:'權益曲線', data:eq.map(x=>x.nav), borderWidth:1.8, pointRadius:0}] },
        options:{ responsive:true, maintainAspectRatio:false,
          scales:{ x:{ ticks:{ color:'#6b7280' }}, y:{ ticks:{ color:'#6b7280' }}},
          plugins:{ legend:{ labels:{ color:'#334155' }}}
        }
      });
    }
    function renderBasic(k, trades){
      const el = document.getElementById('basicSummary');
      const winRate = trades.length? (trades.filter(t=>t.pnl>0).length/trades.length) : 0;
      const expectancy = trades.length? (k.totalPnL/trades.length) : 0;
      const cells = [
        ['累積獲利', fmt(k.totalPnL)],
        ['交易數', trades.length.toLocaleString()],
        ['勝率', pct(winRate)],
        ['平均每筆', fmt(expectancy)],
        ['最大回撤', '-'+fmt(k.maxDD)],
        ['TUW 最長(天)', (k.maxTUW||0)+' 天'],
      ];
      el.innerHTML = cells.map(([t,v])=>`<div class="kpi"><h3>${t}</h3><div class="val">${v}</div></div>`).join('');
    }
    function renderRR(k){
      const rr = [
        ['CAGR', pct(k.CAGR)],
        ['Sharpe', k.sharpe.toFixed(2)],
        ['Sortino', k.sortino.toFixed(2)],
        ['MAR (CAGR/MDD)', k.MAR.toFixed(2)],
        ['VaR 95%', '-'+fmt(k.VaR95)],
        ['ES 95%', '-'+fmt(k.ES95)],
        ['VaR 99%', '-'+fmt(k.VaR99)],
        ['ES 99%', '-'+fmt(k.ES99)],
        ['回撤區間', (k.ddStart||'—')+' → '+(k.ddEnd||'—')],
      ];
      document.getElementById('rr-grid').innerHTML =
        rr.map(([t,v])=>`<div class="kpi"><h3>${t}</h3><div class="val">${v}</div></div>`).join('');
    }
    function renderTable(trades){
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = trades.map((t,i)=>`<tr>
        <td>${i+1}</td><td>${t.date}</td><td>${t.time}</td>
        <td>${t.dir||''}</td><td style="text-align:right">${t.qty||1}</td>
        <td>${t.inPx||''}</td><td>${t.outPx||''}</td>
        <td>${Number.isFinite(t.pts)?t.pts:''}</td>
        <td>${fmt(t.pnl)}</td>
      </tr>`).join('');
    }

    // ---------- 事件 ----------
    document.getElementById('pasteBtn').onclick = async ()=>{
      try{ document.getElementById('raw').value = await navigator.clipboard.readText(); }
      catch{ alert('讀取剪貼簿失敗，請手動貼上(Ctrl+V)。'); }
    };
    document.getElementById('fileInput').addEventListener('change',e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ document.getElementById('raw').value=r.result; }; r.readAsText(f);
    });
    document.getElementById('runBtn').onclick = ()=>{
      const raw = document.getElementById('raw').value.trim();
      if(!raw){ alert('請先貼上或上傳 TXT'); return; }
      const nav = parseFloat(document.getElementById('navInput').value||'1000000');
      const rf  = parseFloat(document.getElementById('rfInput').value||'0');
      const { trades, daily } = parseText(raw);
      if(!trades.length){ alert('未解析到交易資料，請確認欄位（日期/時間/損益 或 點數）'); return; }
      const k = computeRiskReturnKPI(daily, nav, rf);
      renderEquity(k.eq);
      renderBasic(k, trades);
      renderRR(k);
      renderTable(trades);
    };
  </script>
</body>
</html>
