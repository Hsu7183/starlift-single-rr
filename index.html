<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>三劍客量化科技（籌備中）｜策略分析系統</title>
  <style>
    :root { --card-r:12px; }
    body{
      font-family: Arial, "微軟正黑體", sans-serif;
      margin: 20px;
      background:#f8f9fa;
      color:#333;
    }
    h1{
      text-align:center;
      margin:0 0 6px 0;
      font-weight: 800;
      letter-spacing:.5px;
    }
    .subtitle{
      text-align:center;
      color:#666;
      margin:0 0 18px 0;
      font-size:14px;
    }
    hr{
      border:none;
      border-top:1px solid #ddd;
      margin:20px auto;
      max-width:900px;
    }

    /* 區塊抬頭 */
    .section-title-red{
      max-width:1100px;
      margin: 10px auto 12px;
      font-size:20px;
      font-weight:800;
      color:#d32f2f;
      letter-spacing:.5px;
    }
    .section-title-blue{
      max-width:1100px;
      margin: 10px auto 12px;
      font-size:20px;
      font-weight:800;
      color:#0d6efd;
      letter-spacing:.5px;
    }

    /* 策略（固定三欄） */
    .strategy-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:20px;
      max-width:1100px;
      margin: 0 auto 28px;
    }
    .strategy-col{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .subcat{
      font-weight:700;
      font-size:16px;
      color:#c62828;
      margin:0 0 4px 0;
      text-align:center;
    }

    /* 卡片網格（分析區） */
    .nav{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:20px;
      max-width: 1100px;
      margin: 0 auto 28px;
    }

    a.card{
      display:block;
      background:#fff;
      padding:20px;
      border-radius: var(--card-r);
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      text-decoration:none;
      color:inherit;
      transition: transform .15s ease, box-shadow .15s ease;
      position: relative;
      border:1px solid #e5e7eb;
    }
    a.card:hover{ transform: translateY(-4px); box-shadow:0 10px 22px rgba(0,0,0,.12); }
    .card-title{ font-weight:700; font-size:18px; margin:0 0 6px 0; text-align:center; }
    .card-title.red{ color:#d32f2f; }
    .card-title.blue{ color:#0d6efd; }
    .card-title.gray{ color:#6c757d; }   /* 研發中=灰色 */
    .card-desc{ margin:0; color:#666; font-size:14px; line-height:1.5; text-align:left; }

    /* 9行資訊（置中） */
    .lines{ margin-top:8px; }
    .line{ margin:2px 0; font-size:12px; color:#111; text-align:center; }
    .line .val{ font-weight:700; }
    .period{ margin-top:4px; color:#666; }

    /* 策略卡不顯示原本描述 */
    .strategy-col .card-desc{ display:none; }

    .tag{
      display:inline-block;
      font-size:12px;
      background:#eef4ff;
      color:#0d6efd;
      border-radius:999px;
      padding:3px 8px;
      margin-left:8px;
      vertical-align:middle;
    }
  </style>
</head>
<body>
  <h1>三劍客量化科技（籌備中）</h1>
  <p class="subtitle">共同創辦人：許夏睿、何冠緯、張宸</p>

  <hr>

  <!-- 策略（固定 3 欄） -->
  <h3 class="section-title-red">策略</h3>
  <div class="strategy-grid">
    <!-- 順勢 -->
    <div class="strategy-col">
      <p class="subcat">順勢</p>

      <!-- 0807 -->
      <a class="card" href="0807.html">
        <p class="card-title red">0807版本</p>
        <div class="lines">
          <p class="line">近1個月年化報酬率：<span id="w1m-0807" class="val">—</span></p>
          <p class="line">近2個月年化報酬率：<span id="w2m-0807" class="val">—</span></p>
          <p class="line">近3個月年化報酬率：<span id="w3m-0807" class="val">—</span></p>
          <p class="line">近6個月年化報酬率：<span id="w6m-0807" class="val">—</span></p>
          <p class="line">近1年年化報酬率：<span id="w1y-0807" class="val">—</span></p>
          <p class="line">近2年年化報酬率：<span id="w2y-0807" class="val">—</span></p>
          <p class="line">近3年年化報酬率：<span id="w3y-0807" class="val">—</span></p>
          <p class="line">近6年年化報酬率：<span id="w6y-0807" class="val">—</span></p>
          <p class="line period">期間：<span id="period-0807">—</span></p>
        </div>
      </a>

      <!-- 1001 -->
      <a class="card" href="1001.html">
        <p class="card-title red">1001版本</p>
        <div class="lines">
          <p class="line">近1個月年化報酬率：<span id="w1m-1001" class="val">—</span></p>
          <p class="line">近2個月年化報酬率：<span id="w2m-1001" class="val">—</span></p>
          <p class="line">近3個月年化報酬率：<span id="w3m-1001" class="val">—</span></p>
          <p class="line">近6個月年化報酬率：<span id="w6m-1001" class="val">—</span></p>
          <p class="line">近1年年化報酬率：<span id="w1y-1001" class="val">—</span></p>
          <p class="line">近2年年化報酬率：<span id="w2y-1001" class="val">—</span></p>
          <p class="line">近3年年化報酬率：<span id="w3y-1001" class="val">—</span></p>
          <p class="line">近6年年化報酬率：<span id="w6y-1001" class="val">—</span></p>
          <p class="line period">期間：<span id="period-1001">—</span></p>
        </div>
      </a>
    </div>

    <!-- 逆勢 -->
    <div class="strategy-col">
      <p class="subcat">逆勢</p>
      <a class="card" href="#"><p class="card-title gray">研發中</p></a>
    </div>

    <!-- 盤整 -->
    <div class="strategy-col">
      <p class="subcat">盤整</p>
      <a class="card" href="#"><p class="card-title gray">研發中</p></a>
    </div>
  </div>

  <hr>

  <!-- 分析（藍色標題；三欄兩列） -->
  <h3 class="section-title-blue">分析</h3>
  <div class="nav">
    <a class="card" href="single.html">
      <p class="card-title blue">單檔分析</p>
      <p class="card-desc">分析單一檔案，輸出收益曲線、KPI、交易統計與關鍵指標。</p>
    </a>

    <a class="card" href="multi.html">
      <p class="card-title blue">多檔分析</p>
      <p class="card-desc">同時上傳多個檔案，輸出彙總表、分策略／分年度統計與比較。</p>
    </a>

    <a class="card" href="monthly.html">
      <p class="card-title blue">分月報告</p>
      <p class="card-desc">自動按月份拆分績效，提供月度盈虧、勝率、PF、MDD 等報告。</p>
    </a>

    <a class="card" href="upload.html">
      <p class="card-title blue">資料上傳區</p>
      <p class="card-desc">上傳／檢視／下載／刪除回測與實倉報表，支援多檔批次處理。</p>
    </a>

    <a class="card" href="single-cloud.html">
      <p class="card-title blue">雲端單檔分析 <span class="tag">第5分頁</span></p>
      <p class="card-desc">直接從「資料上傳區」挑選檔案進行單檔分析，免重複上傳。</p>
    </a>

    <a class="card" href="multi-adv.html">
      <p class="card-title blue">多檔分析進階版 <span class="tag">第6分頁</span></p>
      <p class="card-desc">進階彙總＋參數欄；支援一鍵開啟單檔分析（機構級）與指標對照。</p>
    </a>
  </div>

  <!-- 依賴 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="shared.js?v=txfee45tax2"></script>

  <script>
  (async function(){
    const SUPABASE_URL = "https://byhbmmnacezzgkwfkozs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_xVe8fGbqQ0XGwi4DsmjPMg_Y2RBOD3t";
    const BUCKET = "reports";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      global: { fetch: (u,o={}) => fetch(u,{...o, cache:'no-store'}) }
    });

    const WANT = { "0807": /0807/i, "1001": /1001/i };
    const CANON_RE   = /^(\d{14})\.0{6}\s+(\d+\.\d{6})\s+(新買|平賣|新賣|平買|強制平倉|強平)\s*$/;
    const EXTRACT_RE = /.*?(\d{14})(?:\.0{1,6})?\s+(\d+(?:\.\d{1,6})?)\s*(新買|平賣|新賣|平買|強制平倉|強平)\s*$/;

    function pubUrl(path){
      const { data } = sb.storage.from(BUCKET).getPublicUrl(path);
      return data?.publicUrl || '#';
    }

    function normalizeText(raw){
      let s = raw.replace(/\ufeff/gi,'').replace(/\u200b|\u200c|\u200d/gi,'');
      s = s.replace(/[\x00-\x09\x0B-\x1F\x7F]/g,'');
      s = s.replace(/\r\n?/g,'\n').replace(/\u3000/g,' ');
      const lines = s.split('\n').map(l=>l.replace(/\s+/g,' ').trim()).filter(Boolean);
      return lines.join('\n');
    }
    function canonicalize(txt){
      const out=[], lines = txt.split('\n'); let ok=0;
      for(const l of lines){
        const m = l.match(EXTRACT_RE);
        if(m){
          const ts = m[1], px = Number(m[2]); const p6 = Number.isFinite(px) ? px.toFixed(6) : m[2];
          let act= m[3]; if (act==='強平') act='強制平倉';
          out.push(`${ts}.000000 ${p6} ${act}`); ok++;
        }
      }
      return { canon: out.join('\n'), ok };
    }
    async function fetchSmart(url){
      const res = await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const buf = await res.arrayBuffer();
      for (const enc of ['utf-8','big5','utf-16le','utf-16be']){
        try{
          const td=new TextDecoder(enc,{fatal:false});
          const norm = normalizeText(td.decode(buf));
          const { canon, ok } = canonicalize(norm);
          if (ok>0) return { canon, ok };
        }catch(e){}
      }
      const td=new TextDecoder('utf-8'); const norm=normalizeText(td.decode(buf));
      const { canon, ok } = canonicalize(norm);
      return { canon, ok };
    }
    function parseCanon(text){
      const rows=[]; if(!text) return rows;
      for(const line of text.split('\n')){
        const m = line.match(CANON_RE);
        if (m) rows.push({ ts:m[1], line });
      }
      rows.sort((a,b)=> a.ts.localeCompare(b.ts));
      return rows;
    }
    function mergeByBaseline(baseText, latestText){
      const A = parseCanon(baseText); const B = parseCanon(latestText);
      const baseMin = A.length ? A[0].ts.slice(0,8) : (B.length? B[0].ts.slice(0,8) : '');
      const baseMax = A.length ? A[A.length-1].ts : '';
      const added   = baseMax ? B.filter(x => x.ts > baseMax).map(x => x.line) : B.map(x => x.line);
      const mergedLines = [...A.map(x => x.line), ...added];
      const endDay = mergedLines.length ? mergedLines[mergedLines.length-1].match(CANON_RE)[1].slice(0,8) : baseMin;
      return { combined: mergedLines.join('\n'), start8: baseMin, end8: endDay };
    }
    async function latestFile(regex){
      const { data } = await sb.storage.from(BUCKET).list('', { limit:1000, sortBy:{ column:'name', order:'asc' }});
      const files = (data||[]).filter(it => it.id !== null && regex.test(it.name));
      if(files.length===0) return null;
      const score = n => { const m=(n||'').match(/\b(20\d{6})\b/g); return m? Math.max(...m.map(s=>+s)):0; };
      files.sort((a,b)=>{
        const sa=score(a.name), sb=score(b.name);
        if(sa!==sb) return sb-sa;
        const ta=a.updated_at? Date.parse(a.updated_at):0, tb=b.updated_at? Date.parse(b.updated_at):0;
        if(ta!==tb) return tb-ta;
        return (b.metadata?.size||0)-(a.metadata?.size||0);
      });
      return files[0];
    }
    async function readManifest(name){
      try{
        const { data } = await sb.storage.from(BUCKET).download(`manifests/${name}.json`);
        if (!data) return null;
        return JSON.parse(await data.text());
      }catch{ return null; }
    }

    // 轉日期工具
    function d8ToDate(d8){ return new Date(`${d8.slice(0,4)}-${d8.slice(4,6)}-${d8.slice(6,8)}T00:00:00`); }
    function diffDays(a8,b8){ return Math.max(1, Math.round((d8ToDate(b8)-d8ToDate(a8))/86400000)+1); }
    function fmtPct(x){ return Number.isFinite(x)? (x*100).toFixed(2)+'%' : '—'; }

    // 從 trades 轉日序列（含滑價）
    function dailySeries(trades){
      const m=new Map();
      for(const t of trades){ const d=String(t.tsOut).slice(0,8); m.set(d,(m.get(d)||0)+t.gainSlip); }
      const days=[...m.keys()].sort();
      const vals=days.map(d=>m.get(d));
      return {days, vals};
    }

    // 計算窗口年化
    function windowCAGR(days, vals, nav, winDays){
      if(days.length===0) return null;
      const end = days[days.length-1];
      const thr = new Date(d8ToDate(end).getTime() - (winDays-1)*86400000);
      // 找到 >= thr 的第一個索引
      let i=0; while(i<days.length && d8ToDate(days[i]) < thr) i++;
      const ndStart = i<days.length ? days[i] : days[0];
      const spanDays = diffDays(ndStart, end);
      // 前綴和
      const pref=[0]; for(const v of vals) pref.push(pref[pref.length-1]+v);
      const sum = pref[vals.length] - pref[i];
      const r = sum / nav;
      return Math.pow(1+r, 365/spanDays) - 1;
    }

    async function fillCard(key){
      const el = (id)=>document.getElementById(`${id}-${key}`);
      try{
        const latest = await latestFile(WANT[key]);
        if(!latest){
          ['w1m','w2m','w3m','w6m','w1y','w2y','w3y','w6y','period'].forEach(x=> el(x).textContent='—');
          return;
        }
        const latestText = (await fetchSmart(pubUrl(latest.name))).canon;

        const manifest = await readManifest(key);
        let merged = latestText, start8='', end8='';
        if(manifest?.baseline_path){
          const baseText = (await fetchSmart(pubUrl(manifest.baseline_path))).canon;
          const m = mergeByBaseline(baseText, latestText);
          merged = m.combined; start8 = m.start8; end8 = m.end8;
        }else{
          const rows = parseCanon(latestText);
          start8 = rows.length ? rows[0].ts.slice(0,8) : '';
          end8   = rows.length ? rows[rows.length-1].ts.slice(0,8) : '';
        }

        // 用 shared.js 解析 → 交易 → 日序列（含滑價）
        const parsed  = window.SHARED.parseTXT(merged);
        const report  = window.SHARED.buildReport(parsed.rows);
        const {days, vals} = dailySeries(report.trades);
        const nav = 1_000_000;

        const mapWin = {
          'w1m': 30, 'w2m': 60, 'w3m': 90, 'w6m': 180,
          'w1y': 365, 'w2y': 730, 'w3y': 1095, 'w6y': 2190
        };
        for(const [id,win] of Object.entries(mapWin)){
          const c = windowCAGR(days, vals, nav, win);
          el(id).textContent = fmtPct(c);
        }
        el('period').textContent = `${start8||'—'} ～ ${end8||'—'}`;
      }catch(e){
        ['w1m','w2m','w3m','w6m','w1y','w2y','w3y','w6y','period'].forEach(x=> { const t=el(x); if(t) t.textContent='—'; });
      }
    }

    await Promise.all([fillCard("0807"), fillCard("1001")]);
  })();
  </script>
</body>
</html>
