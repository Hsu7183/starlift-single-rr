<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è³‡æ–™ä¸Šå‚³å€ï¼ˆç¬¬4åˆ†é ï¼‰</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:Arial,"å¾®è»Ÿæ­£é»‘é«”",sans-serif;background:#f8f9fa;color:#333;margin:20px}
    h1{margin:8px 0}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .home{text-decoration:none;color:#0d6efd;font-weight:700}.home::before{content:"â† "}
    .badge{margin-left:auto;background:#eef4ff;color:#0d6efd;padding:4px 8px;border-radius:999px;font-size:12px}
    .panel{background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:16px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    input[type="file"]{padding:6px}
    input[type="text"]{padding:8px;border:1px solid #ddd;border-radius:8px}
    button{padding:8px 14px;border:0;border-radius:8px;cursor:pointer}
    .primary{background:#0d6efd;color:#fff}.danger{background:#dc3545;color:#fff}.link{background:transparent;color:#0d6efd;text-decoration:underline;padding:0}
    .muted{color:#666}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:14px}
    th{background:#fafafa}.right{text-align:right}
    .op a{margin-right:8px}
    .folder{color:#0d6efd;font-weight:600}
    .pathbar{font-size:12px;color:#555;margin:-4px 0 8px}
  </style>
</head>
<body>
  <div class="topbar">
    <a class="home" href="index.html">å›é¦–é </a>
    <span id="projBadge" class="badge">Bucket: reportsï¼ˆPublicï¼‰</span>
  </div>

  <h1>è³‡æ–™ä¸Šå‚³å€</h1>
  <p class="muted" style="margin-top:-6px;">
    ä¸Šå‚³ï¼æª¢è¦–ï¼ä¸‹è¼‰ï¼åˆªé™¤ï¼ˆå®Œå…¨å…¬é–‹ï¼‰ã€‚å‘½åå»ºè­°ï¼š
    <code>ç­–ç•¥-åƒæ•¸-èµ·å§‹æ—¥-çµæŸæ—¥.ext</code>ï¼ˆä¾‹ï¼š<code>0807-ATR20x2-FITX-1m-20231002-20250923.txt</code>ï¼‰ã€‚
  </p>

  <!-- ä¸Šå‚³ -->
  <div class="panel">
    <h3>ä¸Šå‚³æª”æ¡ˆ</h3>
    <div class="row" style="margin-top:6px;">
      <div>
        <label class="muted">é¸æ“‡æª”æ¡ˆ</label><br/>
        <input type="file" id="fileInput" multiple />
      </div>
      <div>
        <label class="muted">å„²å­˜å­è³‡æ–™å¤¾ï¼ˆå¯ç•™ç™½=æ ¹ç›®éŒ„ï¼‰</label><br/>
        <input type="text" id="subfolder" placeholder="ä¾‹å¦‚ï¼š2025-09-24" />
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnUpload">é–‹å§‹ä¸Šå‚³</button>
      </div>
    </div>
    <div id="uploadMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- æ¸…å–® -->
  <div class="panel">
    <div class="row" style="align-items:center; margin-bottom:6px;">
      <h3 style="margin:0;">æª”æ¡ˆæ¸…å–®</h3>
      <span style="flex:1"></span>
      <span class="muted pathbar">ç›®å‰è·¯å¾‘ï¼š<span id="curPath">ï¼ˆæ ¹ç›®éŒ„ï¼‰</span></span>
      <button id="btnRoot">å›åˆ°æ ¹ç›®éŒ„</button>
      <button id="btnShowAll">é¡¯ç¤ºå…¨éƒ¨ï¼ˆå«å­è³‡æ–™å¤¾ï¼‰</button>
      <input type="text" id="prefix" placeholder="ç›´æ¥è¼¸å…¥è³‡æ–™å¤¾ï¼Œä¾‹å¦‚ï¼š2025-09-24/" />
      <button id="btnRefresh">é‡æ–°æ•´ç†</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>ç­–ç•¥ / è³‡æ–™å¤¾</th>
          <th>åƒæ•¸</th>
          <th>èµ·è¨–æœŸé–“</th>
          <th class="right">å¤§å°</th>
          <th>æœ€å¾Œæ›´æ–°</th>
          <th class="right">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="fileTbody">
        <tr><td colspan="6" class="muted">è¼‰å…¥ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

<script>
/* ===== Supabase è¨­å®šï¼ˆä½ çš„å°ˆæ¡ˆï¼‰ ===== */
const SUPABASE_URL      = "https://byhbmmnacezzgkwfkozs.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5aGJtbW5hY2V6emdrd2Zrb3pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1OTE0NzksImV4cCI6MjA3NDE2NzQ3OX0.VCSye3-fKrQphejdJSWAM6iRzv_7gkl8MLe7NeVszR0";
window.SUPABASE_URL = SUPABASE_URL;
window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

const BUCKET_NAME = "reports";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  global:{ fetch:(url,opts={})=>fetch(url,{...opts,cache:'no-store'}) }
});

/* æ¨™ç¤ºç›®å‰å°ˆæ¡ˆ */
(function(){
  const u = new URL(SUPABASE_URL);
  const proj = (u.hostname||"").split(".")[0];
  document.getElementById("projBadge").textContent =
    `Bucket: ${BUCKET_NAME}ï¼ˆPublicï¼‰ï½œProject: ${proj}`;
})();

/* DOM */
const fileInput   = document.getElementById('fileInput');
const subfolderEl = document.getElementById('subfolder');
const prefixEl    = document.getElementById('prefix');
const tbody       = document.getElementById('fileTbody');
const uploadMsg   = document.getElementById('uploadMsg');
const curPathEl   = document.getElementById('curPath');

/* å·¥å…· */
function withDownload(url){ return url ? url + (url.includes('?')?'&':'?') + 'download' : '#'; }
function sanitizeSeg(s){ return (s||'').normalize('NFKD').replace(/[^\w.\-]+/g,'-').replace(/-+/g,'-').replace(/^-+|-+$/g,''); }
function makeSafePath(folder,name){
  const segs=[]; if(folder&&folder.trim()){ for(const raw of folder.split('/')){ const c=sanitizeSeg(raw.trim()); if(c) segs.push(c); } }
  const safeName=sanitizeSeg(name); return (segs.length?segs.join('/')+'/':'')+safeName;
}
function normalizePrefix(v){ v=(v||'').trim(); if(v && !v.endsWith('/')) v+='/'; return v; }
function parseMeta(fullPath){
  const base = fullPath.split('/').pop();
  const name = base.replace(/\.[^.]+$/,'');
  const segs = name.split(/[-_]+/).filter(Boolean);
  const isD = s=>/^\d{8}$/.test(s); const idx=[];
  segs.forEach((s,i)=>{ if(isD(s)) idx.push(i); });
  let strategy='â€”', params='â€”', range='â€”';
  if(idx.length>=2){ const i0=idx[0]; strategy=i0>=1?segs[0]:'â€”'; params=i0>=2?segs.slice(1,i0).join('-'):'â€”'; range=`${segs[i0]}-${segs[idx[1]]}`; }
  else if(idx.length===1){ const i0=idx[0]; strategy=i0>=1?segs[0]:'â€”'; params=i0>=2?segs.slice(1,i0).join('-'):'â€”'; range=segs[i0]; }
  else{ if(segs.length>=1) strategy=segs[0]; if(segs.length>=2) params=segs.slice(1).join('-'); }
  return {strategy,params,range};
}
function formatBytes(bytes){ if(!(bytes>0)) return '0 B'; const k=1024, dm=1, sizes=['B','KB','MB','GB','TB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/Math.pow(k,i)).toFixed(dm))+' '+sizes[i]; }
function toLocal(dt){ try{ return new Date(dt).toLocaleString(); }catch{ return 'â€”'; } }
function copy(txt){ navigator.clipboard?.writeText(txt); }

/* ===== æ¸…å–®ï¼ˆä¸€èˆ¬ï¼šå–®å±¤ï¼›é¡¯ç¤ºå…¨éƒ¨ï¼šéè¿´ï¼‰ ===== */
async function listOnce(path){
  return await sb.storage.from(BUCKET_NAME).list(path, { limit:1000, sortBy:{column:'name',order:'asc'} });
}

async function listRecursive(path="", acc=[]){
  const { data, error } = await listOnce(path);
  if(error) return { data: acc, error };
  for(const it of data||[]){
    if(!it.id && !it.metadata){ // folder
      const child = (path?path:'') + it.name + '/';
      await listRecursive(child, acc);
    }else{
      acc.push({ path:(path?path:'')+it.name, item:it });
    }
  }
  return { data: acc, error:null };
}

/* å–®å±¤é¡¯ç¤ºï¼ˆå«è³‡æ–™å¤¾ï¼‰ */
async function refreshList(){
  const path = normalizePrefix(prefixEl.value);
  curPathEl.textContent = path ? path : 'ï¼ˆæ ¹ç›®éŒ„ï¼‰';
  tbody.innerHTML = '<tr><td colspan="6" class="muted">è¼‰å…¥ä¸­...</td></tr>';

  const { data, error } = await listOnce(path);
  if(error){ tbody.innerHTML = `<tr><td colspan="6" class="muted">è®€å–å¤±æ•—ï¼š${error.message}</td></tr>`; return; }
  if(!data || data.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="muted">ï¼ˆæ²’æœ‰æª”æ¡ˆï¼‰</td></tr>`; return; }

  tbody.innerHTML = '';

  // ä¸Šä¸€å±¤
  if(path){
    const up = path.split('/').filter(Boolean); up.pop();
    const upPath = up.length ? (up.join('/')+'/') : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="folder">â¬† ä¸Šä¸€å±¤</td>
      <td>â€”</td><td>â€”</td><td class="right">â€”</td><td>â€”</td>
      <td class="right"><button class="link" data-goto="${upPath}">è¿”å›</button></td>`;
    tbody.appendChild(tr);
  }

  const folders = data.filter(x => !x.id && !x.metadata);
  const files   = data.filter(x => x.id || x.metadata);

  // è³‡æ–™å¤¾
  for(const f of folders){
    const full = (path?path:'') + f.name + '/';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="folder">ğŸ“ ${f.name}/</td>
      <td>â€”</td><td>â€”</td><td class="right">â€”</td><td>â€”</td>
      <td class="right"><button class="link" data-goto="${full}">é€²å…¥</button></td>`;
    tbody.appendChild(tr);
  }

  // æª”æ¡ˆ
  for(const it of files){
    const fullPath = (path?path:'') + it.name;
    const meta = parseMeta(fullPath);
    const { data: pub } = sb.storage.from(BUCKET_NAME).getPublicUrl(fullPath);
    const viewUrl = pub?.publicUrl || '#';
    const dlUrl   = withDownload(viewUrl);
    const sizeStr = it.metadata?.size ? formatBytes(it.metadata.size) : 'â€”';
    const updated = it.updated_at ? toLocal(it.updated_at) : 'â€”';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${meta.strategy}</td>
      <td>${meta.params}</td>
      <td>${meta.range}</td>
      <td class="right">${sizeStr}</td>
      <td>${updated}</td>
      <td class="right op">
        <a class="link" href="${viewUrl}" target="_blank" rel="noopener">æª¢è¦–</a>
        <a class="link" href="${dlUrl}">ä¸‹è¼‰</a>
        <a class="link" href="#" data-copy="${viewUrl}">è¤‡è£½é€£çµ</a>
        <a class="link" href="#" data-copy="INDEX?file=${encodeURIComponent(viewUrl)}">è¤‡è£½åˆ†æé€£çµ</a>
        <button class="danger" data-path="${fullPath}">åˆªé™¤</button>
      </td>`;
    tbody.appendChild(tr);
  }

  bindRowActions();
}

/* éè¿´é¡¯ç¤ºï¼ˆå…¨ bucket æ”¤å¹³ï¼‰ */
async function showAll(){
  curPathEl.textContent = 'ï¼ˆå…¨éƒ¨æª”æ¡ˆï¼‰';
  tbody.innerHTML = '<tr><td colspan="6" class="muted">å…¨åŸŸæƒæä¸­...</td></tr>';
  const { data, error } = await listRecursive("");
  if(error){ tbody.innerHTML = `<tr><td colspan="6" class="muted">è®€å–å¤±æ•—ï¼š${error.message}</td></tr>`; return; }
  if(!data || data.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="muted">ï¼ˆæ²’æœ‰æª”æ¡ˆï¼‰</td></tr>`; return; }

  // ä¾è·¯å¾‘æ’åº
  data.sort((a,b)=>a.path.localeCompare(b.path));

  tbody.innerHTML = '';
  for(const row of data){
    const fullPath = row.path;
    const it = row.item;
    const meta = parseMeta(fullPath);
    const { data: pub } = sb.storage.from(BUCKET_NAME).getPublicUrl(fullPath);
    const viewUrl = pub?.publicUrl || '#';
    const dlUrl   = withDownload(viewUrl);
    const sizeStr = it.metadata?.size ? formatBytes(it.metadata.size) : 'â€”';
    const updated = it.updated_at ? toLocal(it.updated_at) : 'â€”';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td title="${fullPath}">${meta.strategy}</td>
      <td>${meta.params}</td>
      <td>${meta.range}</td>
      <td class="right">${sizeStr}</td>
      <td>${updated}</td>
      <td class="right op">
        <a class="link" href="${viewUrl}" target="_blank" rel="noopener">æª¢è¦–</a>
        <a class="link" href="${dlUrl}">ä¸‹è¼‰</a>
        <a class="link" href="#" data-copy="${viewUrl}">è¤‡è£½é€£çµ</a>
        <a class="link" href="#" data-copy="INDEX?file=${encodeURIComponent(viewUrl)}">è¤‡è£½åˆ†æé€£çµ</a>
        <button class="danger" data-path="${fullPath}">åˆªé™¤</button>
      </td>`;
    tbody.appendChild(tr);
  }

  bindRowActions();
}

/* ç¶å®šï¼šè³‡æ–™å¤¾è·³è½‰ / åˆªé™¤ / è¤‡è£½ */
function bindRowActions(){
  tbody.querySelectorAll('button[data-goto]').forEach(btn=>{
    btn.onclick = ()=>{ prefixEl.value = btn.getAttribute('data-goto'); refreshList(); };
  });
  tbody.querySelectorAll('button.danger').forEach(btn=>{
    btn.onclick = async ()=>{
      const p = btn.getAttribute('data-path');
      if(!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${p}ã€ï¼Ÿ`)) return;
      const { error } = await sb.storage.from(BUCKET_NAME).remove([p]);
      if(error){ alert('åˆªé™¤å¤±æ•—ï¼š'+error.message); return; }
      // ä¾ç›®å‰æ¨¡å¼åˆ·æ–°
      if(curPathEl.textContent === 'ï¼ˆå…¨éƒ¨æª”æ¡ˆï¼‰') showAll(); else refreshList();
    };
  });
  tbody.querySelectorAll('a[data-copy]').forEach(a=>{
    a.onclick = (e)=>{
      e.preventDefault();
      let v = a.getAttribute('data-copy');
      if(v.startsWith('INDEX?file=')){
        const idx = new URL('./index.html', location.href).href;
        v = idx + '?' + v.split('?')[1];
      }
      copy(v); a.textContent = 'å·²è¤‡è£½'; setTimeout(()=>a.textContent='è¤‡è£½é€£çµ',1200);
    };
  });
}

/* ä¸Šå‚³ï¼ˆåŒ¿åå¯ä¸Šå‚³ï¼›ç•™ç™½=æ ¹ç›®éŒ„ï¼‰ */
document.getElementById('btnUpload').onclick = async ()=>{
  const files = fileInput.files;
  const folder = subfolderEl.value?.trim();
  if(!files || files.length===0){ uploadMsg.textContent='è«‹å…ˆé¸æ“‡æª”æ¡ˆ'; return; }
  uploadMsg.textContent='ä¸Šå‚³ä¸­â€¦';

  for(const f of files){
    const safePath = makeSafePath(folder, f.name);
    const { error } = await sb.storage.from(BUCKET_NAME).upload(safePath, f, {
      upsert:true, cacheControl:'3600', contentType: f.type || 'text/plain'
    });
    if(error){ uploadMsg.innerHTML = `<span style="color:#b90">ä¸Šå‚³å¤±æ•—ï¼š${error.message}</span>`; return; }
  }
  uploadMsg.innerHTML = 'âœ… ä¸Šå‚³å®Œæˆ';
  fileInput.value='';
  // ä¾ç›®å‰æ¨¡å¼åˆ·æ–°
  if(curPathEl.textContent === 'ï¼ˆå…¨éƒ¨æª”æ¡ˆï¼‰') showAll(); else refreshList();
};

/* æ§åˆ¶éˆ• */
document.getElementById('btnRefresh').onclick = refreshList;
document.getElementById('btnRoot').onclick    = ()=>{ prefixEl.value=''; refreshList(); };
document.getElementById('btnShowAll').onclick = showAll;

/* é è¨­è¼‰å…¥æ ¹ç›®éŒ„ */
window.addEventListener('load', refreshList);
</script>
</body>
</html>
