<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>資料上傳區（第4分頁）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, "微軟正黑體", sans-serif; background:#f8f9fa; margin:20px; color:#333; }
    h1 { margin-bottom:6px; }
    .subtitle { color:#666; margin:0 0 20px 0; }
    .panel { background:#fff; padding:16px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.08); margin-bottom:16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="file"] { padding:6px; }
    input[type="text"], input[type="email"], input[type="password"] { padding:8px; border:1px solid #ddd; border-radius:8px; }
    button { padding:8px 14px; border:0; border-radius:8px; cursor:pointer; }
    button.primary { background:#0d6efd; color:#fff; }
    button.danger { background:#dc3545; color:#fff; }
    button.link { background:transparent; color:#0d6efd; text-decoration:underline; padding:0; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th, td { border-bottom:1px solid #eee; padding:10px; text-align:left; font-size:14px; }
    th { background:#fafafa; }
    .right { text-align:right; }
    .muted { color:#666; }
    .hint { font-size:12px; color:#777; }
    .ok { color:#128a27; }
    .warn { color:#b90; }

    /* 顶部導覽：回首頁 */
    .topbar { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .home { text-decoration:none; color:#0d6efd; font-weight:700; }
    .home::before{ content:"← "; }
    .spacer { flex:1; }
    .badge { background:#eef4ff; color:#0d6efd; padding:4px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <div class="topbar">
    <a class="home" href="index.html">回首頁</a>
    <span class="spacer"></span>
    <span class="badge">Bucket: reports</span>
  </div>

  <h1>資料上傳區</h1>
  <p class="subtitle">上傳 / 瀏覽 / 下載 / 刪除報表檔案（PDF、TXT…）。</p>

  <!-- 登入／註冊 -->
  <div class="panel" id="authPanel">
    <h3>登入</h3>
    <div class="row">
      <input id="email" type="email" placeholder="Email（至少 6 碼密碼）" />
      <input id="password" type="password" placeholder="密碼（最少 6 碼）" />
      <button class="primary" id="btnSignIn">登入</button>
      <button id="btnSignUp">註冊</button>
      <button id="btnSignOut" style="display:none;">登出</button>
    </div>
    <div id="authMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- 上傳區（白名單可見；真正權限靠 Policies） -->
  <div class="panel" id="uploadPanel" style="display:none;">
    <h3>上傳檔案</h3>
    <div class="row">
      <span id="writerBadge" class="muted"></span>
    </div>
    <div class="row" style="margin-top:6px;">
      <div>
        <label class="muted">選擇檔案</label><br/>
        <input type="file" id="fileInput" multiple />
      </div>
      <div>
        <label class="muted">儲存子資料夾（建議用日期：2025-09-23）</label><br/>
        <input type="text" id="subfolder" placeholder="例如：2025-09-23" />
      </div>
      <div style="align-self:end;">
        <button class="primary" id="btnUpload">開始上傳</button>
      </div>
    </div>
    <div id="uploadMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- 清單區 -->
  <div class="panel">
    <div class="row" style="align-items:center; margin-bottom:6px;">
      <h3 style="margin:0;">檔案清單</h3>
      <span class="spacer"></span>
      <span class="badge">命名建議：策略-參數-起始日-結束日.ext</span>
    </div>
    <div class="row" style="margin-bottom:8px;">
      <input type="text" id="prefix" placeholder="篩選資料夾（例如：2025-09-23/）" style="flex:1;" />
      <button id="btnRefresh">重新整理</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>策略</th>
          <th>參數</th>
          <th>起訖期間</th>
          <th class="right">大小</th>
          <th>最後更新</th>
          <th class="right">操作</th>
        </tr>
      </thead>
      <tbody id="fileTbody">
        <tr><td colspan="6" class="muted">載入中...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // ====== Supabase 專案設定 ======
    const SUPABASE_URL = "https://byhbmmnacezzgkwfkozs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_xVe8fGbqQ0XGwi4DsmjPMg_Y2RBOD3t";
    const BUCKET_NAME = "reports";
    // ===============================

    // TODO：把三位合夥人的 Email（小寫）填進來
    const ALLOWED_WRITERS = [
      "user_hsu@example.com",   // 許
      "user_ho@example.com",    // 何
      "user_chang@example.com", // 張
    ].map(s => s.toLowerCase());

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authPanel = document.getElementById('authPanel');
    const uploadPanel = document.getElementById('uploadPanel');
    const writerBadge = document.getElementById('writerBadge');
    const authMsg = document.getElementById('authMsg');
    const uploadMsg = document.getElementById('uploadMsg');

    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const btnSignOut = document.getElementById('btnSignOut');

    const fileInput = document.getElementById('fileInput');
    const subfolderEl = document.getElementById('subfolder');
    const prefixEl = document.getElementById('prefix');
    const tbody = document.getElementById('fileTbody');

    function withDownloadParam(url) {
      if (!url || url === '#') return '#';
      return url + (url.includes('?') ? '&' : '?') + 'download';
    }

    function parseFileMeta(fullPath) {
      const base = fullPath.split('/').pop();
      const nameNoExt = base.replace(/\.[^.]+$/, '');
      const segs = nameNoExt.split(/[-_]+/).filter(Boolean);
      const isDate8 = (s) => /^\d{8}$/.test(s);
      const dateIdx = [];
      segs.forEach((s, i) => { if (isDate8(s)) dateIdx.push(i); });

      let strategy = '—', params = '—', range = '—';
      if (dateIdx.length >= 2) {
        const i0 = dateIdx[0];
        strategy = i0 >= 1 ? segs[0] : '—';
        params   = i0 >= 2 ? segs.slice(1, i0).join('-') : '—';
        range    = `${segs[i0]}-${segs[dateIdx[1]]}`;
      } else if (dateIdx.length === 1) {
        const i0 = dateIdx[0];
        strategy = i0 >= 1 ? segs[0] : '—';
        params   = i0 >= 2 ? segs.slice(1, i0).join('-') : '—';
        range    = segs[i0];
      } else {
        if (segs.length >= 1) strategy = segs[0];
        if (segs.length >= 2) params   = segs.slice(1).join('-');
      }
      return { strategy, params, range };
    }

    function sanitizeSegment(s) {
      return (s || '')
        .normalize('NFKD')
        .replace(/[^\w.\-]+/g, '-') .replace(/-+/g, '-') .replace(/^-+|-+$/g, '');
    }
    function makeSafePath(folder, fileName) {
      const segs = [];
      if (folder && folder.trim()) {
        for (const raw of folder.split('/')) {
          const cleaned = sanitizeSegment(raw.trim());
          if (cleaned) segs.push(cleaned);
        }
      }
      const safeName = sanitizeSegment(fileName);
      return (segs.length ? segs.join('/') + '/' : '') + safeName;
    }
    function normalizePrefix(v) { v = (v || '').trim(); if (v && !v.endsWith('/')) v += '/'; return v; }

    async function getCurrentEmail() {
      const { data } = await supabase.auth.getUser();
      const email = data?.user?.email || '';
      return email.toLowerCase();
    }
    function isWriter(email) { return !!email && ALLOWED_WRITERS.includes(email.toLowerCase()); }

    async function refreshAuthUI() {
      const { data: { session } } = await supabase.auth.getSession();
      const loggedIn = !!session;
      const email = loggedIn ? (await getCurrentEmail()) : '';

      btnSignOut.style.display = loggedIn ? 'inline-block' : 'none';

      if (!loggedIn) {
        uploadPanel.style.display = 'none';
        writerBadge.innerHTML = '';
        return;
      }
      if (isWriter(email)) {
        uploadPanel.style.display = 'block';
        writerBadge.innerHTML = `<span class="ok">登入身份：${email}（具備上傳/刪除權限）</span>`;
      } else {
        uploadPanel.style.display = 'none';
        writerBadge.innerHTML = '';
        authMsg.innerHTML = `<span class="warn">已登入：${email}，但不在授權名單，僅可瀏覽/下載。</span>`;
      }
    }

    supabase.auth.onAuthStateChange((_event, _session) => { refreshAuthUI(); refreshList(); });

    document.getElementById('btnSignIn').onclick = async () => {
      authMsg.textContent = '登入中…';
      const { error } = await supabase.auth.signInWithPassword({ email: emailEl.value.trim(), password: passwordEl.value });
      authMsg.textContent = error ? '登入失敗：' + error.message : '✅ 登入成功';
    };
    document.getElementById('btnSignUp').onclick = async () => {
      authMsg.textContent = '註冊中…';
      const { error } = await supabase.auth.signUp({ email: emailEl.value.trim(), password: passwordEl.value });
      authMsg.textContent = error ? '註冊失敗：' + error.message : '✅ 註冊成功，若需信箱驗證請至信箱完成';
    };
    btnSignOut.onclick = async () => { await supabase.auth.signOut(); alert('已登出'); refreshAuthUI(); refreshList(); };

    async function refreshList() {
      tbody.innerHTML = '<tr><td colspan="6" class="muted">載入中...</td></tr>';
      const path = normalizePrefix(prefixEl.value);
      const { data, error } = await supabase.storage.from(BUCKET_NAME).list(path, { limit: 1000, sortBy: { column: 'name', order: 'asc' } });
      if (error) { tbody.innerHTML = `<tr><td colspan="6" class="muted">讀取失敗：${error.message}</td></tr>`; return; }
      if (!data || data.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="muted">（沒有檔案）</td></tr>`; return; }

      tbody.innerHTML = '';
      for (const item of data) {
        if (item.id === null && !item.metadata) continue; // 資料夾
        const fullPath = (path ? path : '') + item.name;
        const meta = parseFileMeta(fullPath);

        const { data: pub } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fullPath);
        const viewUrl = pub?.publicUrl || '#';
        const downloadUrl = withDownloadParam(viewUrl);

        const sizeStr = item.metadata?.size ? formatBytes(item.metadata.size) : '—';
        const updatedAt = item.updated_at ? new Date(item.updated_at).toLocaleString() : '—';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${meta.strategy}</td>
          <td>${meta.params}</td>
          <td>${meta.range}</td>
          <td class="right">${sizeStr}</td>
          <td>${updatedAt}</td>
          <td class="right">
            <a class="link" href="${viewUrl}" target="_blank" rel="noopener">檢視</a>
            &nbsp;|&nbsp;
            <a class="link" href="${downloadUrl}">下載</a>
            &nbsp;|&nbsp;
            <button class="danger" data-path="${fullPath}">刪除</button>
          </td>`;
        tbody.appendChild(tr);
      }

      tbody.querySelectorAll('button.danger').forEach(btn => {
        btn.onclick = async () => {
          const p = btn.getAttribute('data-path');
          if (!confirm(`確定刪除「${p}」？`)) return;
          const { error } = await supabase.storage.from(BUCKET_NAME).remove([p]);
          if (error) alert('刪除失敗：' + error.message);
          refreshList();
        };
      });
    }

    document.getElementById('btnRefresh').onclick = refreshList;
    window.addEventListener('load', async () => { await refreshAuthUI(); await refreshList(); });

    document.getElementById('btnUpload').onclick = async () => {
      const files = fileInput.files;
      const folder = subfolderEl.value?.trim();
      if (!files || files.length === 0) { uploadMsg.textContent = '請先選擇檔案'; return; }
      uploadMsg.textContent = '上傳中…';
      for (const f of files) {
        const safePath = makeSafePath(folder, f.name);
        try {
          const { error } = await supabase.storage.from(BUCKET_NAME).upload(safePath, f, {
            upsert: true, cacheControl: '3600', contentType: f.type || 'text/plain'
          });
          if (error) { console.error('Upload error:', error); uploadMsg.textContent = `上傳失敗：${error.message || '未知錯誤'}`; return; }
        } catch (e) { console.error('Upload fetch failed:', e); uploadMsg.textContent = `上傳失敗（網路/權限）：${e?.message || e}`; return; }
      }
      uploadMsg.textContent = '✅ 上傳完成';
      fileInput.value = ''; refreshList();
    };

    function formatBytes(bytes) {
      if (!bytes) return '0 B';
      const k = 1024, dm = 1, sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes)/Math.log(k));
      return parseFloat((bytes/Math.pow(k,i)).toFixed(dm)) + ' ' + sizes[i];
    }
  </script>
</body>
</html>
