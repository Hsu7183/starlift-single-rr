<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>上傳檔案</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --danger:#ef4444;
      --danger-dark:#b91c1c;
      --bg:#f3f4f6;
      --card-bg:#ffffff;
      --border:#e5e7eb;
      --text-main:#111827;
      --text-muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",
                   "Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--text-main);
      margin:0;
      padding:20px 12px 40px;
    }
    .container{
      max-width:1100px;
      margin:0 auto;
    }
    h1{
      margin:4px 0 2px 0;
      font-size:20px;
      letter-spacing:0.03em;
    }
    .subtitle{
      margin:0 0 12px 0;
      font-size:13px;
      color:var(--text-muted);
    }
    code{
      background:#e5e7eb;
      padding:1px 5px;
      border-radius:4px;
      font-size:12px;
    }
    .panel{
      background:var(--card-bg);
      padding:16px 18px;
      border-radius:14px;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
      margin-bottom:18px;
      border:1px solid rgba(148,163,184,.3);
    }
    .panel-title{
      font-size:15px;
      font-weight:600;
      margin:0 0 8px 0;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }

    /* 按鈕樣式 */
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding:8px 16px;
      border-radius:999px;
      font-size:14px;
      border:1px solid transparent;
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,transform .08s ease,
                 box-shadow .15s ease,color .15s ease;
      text-decoration:none;
      user-select:none;
      white-space:nowrap;
    }
    .btn-sm{
      padding:5px 11px;
      font-size:13px;
    }
    .btn-primary{
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 6px 14px rgba(37,99,235,.3);
    }
    .btn-primary:hover{
      background:var(--primary-dark);
      border-color:var(--primary-dark);
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(37,99,235,.35);
    }
    .btn-outline{
      background:#ffffff;
      border-color:#c7d2fe;
      color:var(--primary);
    }
    .btn-outline:hover{
      background:#eff6ff;
      border-color:var(--primary);
      transform:translateY(-1px);
      box-shadow:0 6px 14px rgba(37,99,235,.18);
    }
    .btn-danger{
      background:var(--danger);
      border-color:var(--danger);
      color:#fff;
      box-shadow:0 6px 14px rgba(239,68,68,.3);
    }
    .btn-danger:hover{
      background:var(--danger-dark);
      border-color:var(--danger-dark);
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(239,68,68,.35);
    }

    input[type="file"]{
      padding:6px 0;
      font-size:14px;
    }

    .muted{color:var(--text-muted);font-size:13px;}

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      border-bottom:1px solid var(--border);
      padding:9px 10px;
      text-align:left;
      font-size:13px;
    }
    th{
      background:#f9fafb;
      font-weight:600;
      color:#4b5563;
    }
    tbody tr:nth-child(even){
      background:#f9fafb;
    }
    tbody tr:last-child td{
      border-bottom:none;
    }
    .right{text-align:right}
    .op{
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    #uploadMsg{min-height:18px;}
  </style>
</head>
<body>
<div class="container">
  <h1>上傳檔案</h1>
  <p class="subtitle">
    檔名建議：<code>策略-參數-起始日-結束日.txt</code>（例如：<code>0807-KPI-20231002-20250923.txt</code>）。
  </p>

  <!-- 上傳 -->
  <div class="panel">
    <p class="panel-title">選擇檔案</p>
    <div class="row" style="margin-top:4px;">
      <div>
        <input type="file" id="fileInput" multiple />
      </div>
      <div style="align-self:flex-end;">
        <button class="btn btn-primary" id="btnUpload">上傳</button>
      </div>
    </div>
    <div id="uploadMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- 清單 -->
  <div class="panel">
    <div class="row" style="align-items:center; margin-bottom:6px;">
      <h3 class="panel-title" style="margin-bottom:0;">檔案清單</h3>
    </div>
    <table>
      <thead>
        <tr>
          <th>策略</th>
          <th>參數</th>
          <th>起訖期間</th>
          <th class="right">大小</th>
          <th>最後更新</th>
          <th class="right">操作</th>
        </tr>
      </thead>
      <tbody id="fileTbody">
        <tr><td colspan="6" class="muted">載入中...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/* ===== Supabase 設定 ===== */
const SUPABASE_URL      = "https://byhbmmnacezzgkwfkozs.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5aGJtbW5hY2V6emdrd2Zrb3pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1OTE0NzksImV4cCI6MjA3NDE2NzQ3OX0.VCSye3-fKrQphejdJSWAM6iRzv_7gkl8MLe7NeVszR0";
window.SUPABASE_URL = SUPABASE_URL;
window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

const BUCKET_NAME = "reports";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  global:{ fetch:(url,opts={})=>fetch(url,{...opts,cache:'no-store'}) }
});

/* DOM */
const fileInput = document.getElementById('fileInput');
const tbody     = document.getElementById('fileTbody');
const uploadMsg = document.getElementById('uploadMsg');

/* 工具 */
function withDownload(url){
  return url ? url + (url.includes('?') ? '&' : '?') + 'download' : '#';
}
function sanitizeSeg(s){
  return (s||'')
    .normalize('NFKD')
    .replace(/[^\w.\-]+/g,'-')
    .replace(/-+/g,'-')
    .replace(/^-+|-+$/g,'');
}
function makeSafePath(name){
  const safeName = sanitizeSeg(name);
  return safeName || name;
}
function parseMeta(fullPath){
  const base = fullPath.split('/').pop();
  const name = base.replace(/\.[^.]+$/,'');
  const segs = name.split(/[-_]+/).filter(Boolean);
  const isD = s=>/^\d{8}$/.test(s);
  const idx=[];
  segs.forEach((s,i)=>{ if(isD(s)) idx.push(i); });
  let strategy='—', params='—', range='—';
  if(idx.length>=2){
    const i0=idx[0];
    strategy = i0>=1 ? segs[0] : '—';
    params   = i0>=2 ? segs.slice(1,i0).join('-') : '—';
    range    = `${segs[i0]}-${segs[idx[1]]}`;
  }else if(idx.length===1){
    const i0=idx[0];
    strategy = i0>=1 ? segs[0] : '—';
    params   = i0>=2 ? segs.slice(1,i0).join('-') : '—';
    range    = segs[i0];
  }else{
    if(segs.length>=1) strategy = segs[0];
    if(segs.length>=2) params   = segs.slice(1).join('-');
  }
  return {strategy,params,range};
}
function formatBytes(bytes){
  if(!(bytes>0)) return '0 B';
  const k=1024, dm=1, sizes=['B','KB','MB','GB','TB'];
  const i=Math.floor(Math.log(bytes)/Math.log(k));
  return parseFloat((bytes/Math.pow(k,i)).toFixed(dm))+' '+sizes[i];
}
function toLocal(dt){
  try{ return new Date(dt).toLocaleString(); }
  catch{ return '—'; }
}

/* 讀取：遞迴掃描整個 bucket */
async function listOnce(path){
  return await sb.storage.from(BUCKET_NAME).list(path, {
    limit:1000,
    sortBy:{column:'name',order:'asc'}
  });
}

async function listRecursive(path="", acc=[]){
  const { data, error } = await listOnce(path);
  if(error) return { data: acc, error };
  for(const it of data || []){
    if(!it.id && !it.metadata){ // 資料夾
      const child = (path ? path : '') + it.name + '/';
      await listRecursive(child, acc);
    }else{
      acc.push({ path:(path?path:'')+it.name, item:it });
    }
  }
  return { data: acc, error:null };
}

/* 顯示全部檔案（攤平成一張表） */
async function showAll(){
  tbody.innerHTML = '<tr><td colspan="6" class="muted">載入中...</td></tr>';
  const { data, error } = await listRecursive("");
  if(error){
    tbody.innerHTML = `<tr><td colspan="6" class="muted">讀取失敗：${error.message}</td></tr>`;
    return;
  }
  if(!data || data.length===0){
    tbody.innerHTML = `<tr><td colspan="6" class="muted">（沒有檔案）</td></tr>`;
    return;
  }

  data.sort((a,b)=>a.path.localeCompare(b.path));

  tbody.innerHTML = '';
  for(const row of data){
    const fullPath = row.path;
    const it = row.item;
    const meta = parseMeta(fullPath);
    const { data: pub } = sb.storage.from(BUCKET_NAME).getPublicUrl(fullPath);
    const viewUrl = pub?.publicUrl || '#';
    const dlUrl   = withDownload(viewUrl);
    const sizeStr = it.metadata?.size ? formatBytes(it.metadata.size) : '—';
    const updated = it.updated_at ? toLocal(it.updated_at) : '—';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td title="${fullPath}">${meta.strategy}</td>
      <td>${meta.params}</td>
      <td>${meta.range}</td>
      <td class="right">${sizeStr}</td>
      <td>${updated}</td>
      <td class="right">
        <div class="op">
          <a class="btn btn-outline btn-sm" href="${dlUrl}">下載</a>
          <button class="btn btn-danger btn-sm danger" data-path="${fullPath}">刪除</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  }

  bindRowActions();
}

/* 綁定刪除 */
function bindRowActions(){
  tbody.querySelectorAll('button.danger').forEach(btn=>{
    btn.onclick = async ()=>{
      const p = btn.getAttribute('data-path');
      if(!confirm(`確定刪除「${p}」？`)) return;
      const { error } = await sb.storage.from(BUCKET_NAME).remove([p]);
      if(error){
        alert('刪除失敗：'+error.message);
        return;
      }
      showAll();
    };
  });
}

/* 上傳（匿名可上傳） */
document.getElementById('btnUpload').onclick = async ()=>{
  const files = fileInput.files;
  if(!files || files.length===0){
    uploadMsg.textContent='請先選擇檔案';
    return;
  }
  uploadMsg.textContent='上傳中…';

  for(const f of files){
    const safePath = makeSafePath(f.name);
    const { error } = await sb.storage.from(BUCKET_NAME).upload(safePath, f, {
      upsert:true,
      cacheControl:'3600',
      contentType: f.type || 'text/plain'
    });
    if(error){
      uploadMsg.innerHTML = `<span style="color:#b91c1c">上傳失敗：${error.message}</span>`;
      return;
    }
  }
  uploadMsg.innerHTML = '✅ 上傳完成';
  fileInput.value='';
  showAll();
};

/* 載入時顯示全部檔案 */
window.addEventListener('load', showAll);
</script>
</body>
</html>
