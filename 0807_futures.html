<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>0807 台指期單檔分析</title>
  <style>
    body{font-family:ui-sans-serif,system-ui;-webkit-font-smoothing:antialiased;margin:0;padding:16px;background:#f7f7fb}
    .wrap{max-width:1440px;margin:0 auto}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-block;background:#eef;padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{background:#0d6efd;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-size:14px}
    .btn.gray{background:#6c757d}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03);padding:12px;margin-bottom:20px}
    #chartBox{height:520px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:6px 8px;font-size:13px;white-space:nowrap}
    th{background:#fafafa;text-align:left}
    .back-link{margin-bottom:12px;display:inline-block}
    .scroll-x{overflow-x:auto}
    .muted{color:#666;font-size:13px}
    #autostatus{white-space:pre-wrap}
    textarea{width:100%;min-height:220px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;border-radius:8px;border:1px solid #d4d4d8;padding:8px;box-sizing:border-box}
    .pos{color:#b91c1c;font-weight:600}
    .neg{color:#065f46;font-weight:600}
    #kpiAll table{width:auto}
    #kpiAll td:first-child{font-weight:600}
  </style>
  <!-- 只需要 Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="wrap">
    <a class="back-link" href="index.html">← 返回首頁</a>
    <h1>0807 台指期單檔分析</h1>
    <p class="muted">
      1. 請把 0807 輸出的 TXT（第一行參數 + 後面「時間 價格 動作」）貼到下方框框。<br>
      2. 每次只假設 1 口台指期，預設 1 點 = 50 元，可自行修改。
    </p>

    <!-- 輸入區 -->
    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <button id="btnRun" class="btn">開始分析</button>
        <label class="muted">
          每點價值（元）：
          <input id="pointValue" type="number" value="50" style="width:80px;padding:4px 6px;border-radius:8px;border:1px solid #d4d4d8;margin-left:4px">
        </label>
        <span class="muted">（台指期一口預設 50 元）</span>
      </div>
      <textarea id="txtInput" placeholder="在這裡貼上 0807 輸出的 TXT"></textarea>
    </div>

    <!-- 參數顯示 -->
    <div class="card">
      <div class="row">
        <strong>策略參數</strong>
        <div id="paramArea" class="muted" style="margin-left:8px">尚未載入。</div>
      </div>
    </div>

    <!-- 狀態 -->
    <div class="card">
      <span id="autostatus" class="muted">等待貼上 TXT…</span>
    </div>

    <!-- 資產曲線 -->
    <div id="chartBox" class="card">
      <canvas id="chart"></canvas>
    </div>

    <!-- KPI -->
    <div id="kpiAll" class="card scroll-x"></div>

    <!-- Risk-Return 區塊先簡單放長/空統計 -->
    <div id="rrLines" class="card scroll-x"></div>

    <!-- 交易明細 -->
    <div class="card scroll-x">
      <table id="tradeTable">
        <thead>
          <tr>
            <th>#</th>
            <th>方向</th>
            <th>進場時間</th>
            <th>進場價</th>
            <th>出場時間</th>
            <th>出場價</th>
            <th>點數</th>
            <th>損益(元)</th>
            <th>累計(元)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const $ = s => document.querySelector(s);
  const statusEl = $('#autostatus');
  const txtInput = $('#txtInput');
  const btnRun   = $('#btnRun');
  const pvInput  = $('#pointValue');
  const paramArea= $('#paramArea');
  const tradeBody= $('#tradeTable tbody');
  const kpiBox   = $('#kpiAll');
  const rrBox    = $('#rrLines');

  let eqChart;

  btnRun.addEventListener('click', ()=>{
    const raw = txtInput.value.trim();
    if(!raw){
      alert('請先貼上 TXT。');
      return;
    }
    const pointValue = Number(pvInput.value)||50;
    try{
      const { params, trades, equity, longStats, shortStats } = parse0807(raw, pointValue);
      renderParams(params);
      renderTrades(trades);
      renderKPI(trades);
      renderLR(longStats, shortStats);
      renderChart(equity);
      statusEl.textContent = `已完成分析，共 ${trades.length} 筆交易。`;
      statusEl.style.color = '#666';
    }catch(e){
      console.error(e);
      statusEl.textContent = '解析失敗：' + (e.message||e);
      statusEl.style.color = '#c62828';
    }
  });

  // 解析 0807 TXT
  function parse0807(raw, pointValue){
    const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(s=>s);
    if(lines.length < 2) throw new Error('行數不足（至少需要參數行 + 1 筆交易）');

    // 第一行：BeginTime=... EndTime=...
    const paramLine = lines[0];
    const params = {};
    paramLine.split(/\s+/).forEach(chunk=>{
      const [k,v] = chunk.split('=');
      if(k && v!==undefined) params[k.trim()] = v.trim();
    });

    // 後面：時間 價格 動作
    const recs = [];
    for(let i=1;i<lines.length;i++){
      const parts = lines[i].split(/\s+/);
      if(parts.length < 3) continue;
      const ts = parts[0];
      const px = Number(parts[1]);
      const act= parts[2];
      if(!/^\d{14}$/.test(ts) || !Number.isFinite(px)) continue;
      recs.push({ ts, price:px, act });
    }
    if(!recs.length) throw new Error('沒有有效的交易紀錄');

    let pos = 0;    // 0 無，+1 多，-1 空
    let entry = null;
    const trades = [];
    let cumPnl = 0;

    let longCount=0,longPnl=0;
    let shortCount=0,shortPnl=0;

    for(const r of recs){
      const a = r.act;
      if(a === '新買'){
        if(pos !== 0) continue;
        pos = +1;
        entry = { side:'L', tsIn:r.ts, priceIn:r.price };
      }else if(a === '新賣'){
        if(pos !== 0) continue;
        pos = -1;
        entry = { side:'S', tsIn:r.ts, priceIn:r.price };
      }else if(a === '平賣' || a === '平買' || a === '強制平倉'){
        if(pos === 0 || !entry) continue;
        const dir   = (entry.side === 'L') ? +1 : -1;
        const pts   = (r.price - entry.priceIn) * dir;
        const pnl   = pts * pointValue;
        cumPnl     += pnl;

        trades.push({
          side: entry.side,
          tsIn: entry.tsIn,
          priceIn: entry.priceIn,
          tsOut: r.ts,
          priceOut: r.price,
          pnlPts: pts,
          pnlVal: pnl,
          cumPnl: cumPnl
        });

        if(entry.side==='L'){ longCount++; longPnl += pnl; }
        else{ shortCount++; shortPnl += pnl; }

        pos = 0;
        entry = null;
      }
    }

    const equity = trades.map((t,idx)=>({ x:idx+1, y:t.cumPnl }));
    const longStats  = { count:longCount, pnl:longPnl };
    const shortStats = { count:shortCount, pnl:shortPnl };

    return { params, trades, equity, longStats, shortStats };
  }

  // 顯示參數
  function renderParams(params){
    const keys = Object.keys(params);
    if(!keys.length){ paramArea.textContent = '未解析到參數行。'; return; }
    paramArea.innerHTML = '';
    keys.forEach(k=>{
      const span = document.createElement('span');
      span.className='chip';
      span.textContent = `${k}=${params[k]}`;
      paramArea.appendChild(span);
    });
  }

  // 顯示交易明細
  function renderTrades(trades){
    tradeBody.innerHTML = '';
    trades.forEach((t,i)=>{
      const tr = document.createElement('tr');
      const cls = t.pnlVal>0 ? 'pos' : (t.pnlVal<0 ? 'neg' : '');
      tr.innerHTML =
        `<td>${i+1}</td>` +
        `<td>${t.side==='L'?'多':'空'}</td>` +
        `<td>${fmtTs(t.tsIn)}</td>` +
        `<td>${t.priceIn.toFixed(0)}</td>` +
        `<td>${fmtTs(t.tsOut)}</td>` +
        `<td>${t.priceOut.toFixed(0)}</td>` +
        `<td class="${cls}">${t.pnlPts.toFixed(1)}</td>` +
        `<td class="${cls}">${fmtInt(t.pnlVal)}</td>` +
        `<td class="${cls}">${fmtInt(t.cumPnl)}</td>`;
      tradeBody.appendChild(tr);
    });
  }

  // KPI
  function renderKPI(trades){
    if(!trades.length){
      kpiBox.innerHTML = '<p class="muted">沒有完整交易（需要有進有出）。</p>';
      return;
    }
    const n = trades.length;
    let win=0, loss=0, sumWin=0, sumLoss=0, best=-Infinity, worst=Infinity;
    let peak=0, maxDD=0, eq=0;

    trades.forEach(t=>{
      const p = t.pnlVal;
      eq = t.cumPnl;
      if(p>0){ win++; sumWin+=p; if(p>best) best=p; }
      else if(p<0){ loss++; sumLoss+=p; if(p<worst) worst=p; }

      if(eq>peak) peak=eq;
      const dd = peak-eq;
      if(dd>maxDD) maxDD=dd;
    });

    const total   = trades[trades.length-1].cumPnl;
    const winRate = n ? win*100/n : 0;
    const avg     = n ? total/n : 0;
    const pf      = sumLoss<0 ? (sumWin/Math.abs(sumLoss)) : (sumWin>0?Infinity:0);

    const rows = [
      ['總筆數', n],
      ['勝率', `${winRate.toFixed(2)} %`],
      ['總損益(元)', fmtInt(total)],
      ['平均每筆損益', fmtInt(avg)],
      ['最大單筆獲利', best===-Infinity?'—':fmtInt(best)],
      ['最大單筆虧損', worst===Infinity?'—':fmtInt(worst)],
      ['最大回撤(元)', fmtInt(maxDD)],
      ['Profit Factor', pf===Infinity?'∞':pf.toFixed(2)]
    ];

    const html = [
      '<table><tbody>',
      ...rows.map(r=>`<tr><td>${r[0]}</td><td style="text-align:right">${r[1]}</td></tr>`),
      '</tbody></table>'
    ].join('');
    kpiBox.innerHTML = html;
  }

  // Long / Short 統計
  function renderLR(longStats, shortStats){
    const rows = [
      ['多單筆數', longStats.count],
      ['多單總損益', fmtInt(longStats.pnl)],
      ['空單筆數', shortStats.count],
      ['空單總損益', fmtInt(shortStats.pnl)]
    ];
    const html = [
      '<h3 style="margin:0 0 6px">多空統計</h3>',
      '<table><tbody>',
      ...rows.map(r=>`<tr><td>${r[0]}</td><td style="text-align:right">${r[1]}</td></tr>`),
      '</tbody></table>'
    ].join('');
    rrBox.innerHTML = html;
  }

  // 資產曲線
  function renderChart(equity){
    const ctx = document.getElementById('chart').getContext('2d');
    const labels = equity.map(e=>e.x);
    const data   = equity.map(e=>e.y);

    if(eqChart) eqChart.destroy();

    eqChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label:'累計損益(元)',
          data,
          borderWidth:2,
          tension:0.2,
          pointRadius:0
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          x:{ title:{display:true,text:'交易序號'} },
          y:{ title:{display:true,text:'累計損益(元)'} }
        },
        plugins:{
          legend:{display:true},
          tooltip:{
            callbacks:{
              label:(ctx)=>` 累計損益：${fmtInt(ctx.parsed.y)} 元`
            }
          }
        }
      }
    });
  }

  // 小工具
  function fmtInt(n){ return Math.round(n||0).toLocaleString('zh-TW'); }
  function fmtTs(ts){
    if(!ts || ts.length!==14) return ts;
    const y=ts.slice(0,4), m=ts.slice(4,6), d=ts.slice(6,8);
    const hh=ts.slice(8,10), mm=ts.slice(10,12);
    return `${y}-${m}-${d} ${hh}:${mm}`;
  }

})();
</script>
</body>
</html>
