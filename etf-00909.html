<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>00909-ETF版本｜機構級 KPI</title>
  <style>
    :root{ --w:1100px; --r:12px; }
    body{ font-family: Arial,"微軟正黑體",sans-serif; margin:20px; background:#f8f9fa; color:#333; }
    h1{ margin:0 0 6px 0; font-weight:800; letter-spacing:.5px; }
    .sub{ color:#666; margin:0 0 18px 0; font-size:14px; }
    .wrap{ max-width:var(--w); margin:0 auto; }
    .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .home{ display:inline-block; padding:6px 10px; border-radius:10px; border:1px solid #aaa; color:#333; text-decoration:none; font-size:12px; }
    .home:hover{ background:#f2f2f2; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:var(--r); box-shadow:0 2px 8px rgba(0,0,0,.06); padding:16px 18px; margin:14px 0; }
    .meta{ color:#666; font-size:12px; }
    .btn{ display:inline-block; padding:6px 10px; border-radius:10px; border:1px solid #0d6efd; color:#0d6efd; text-decoration:none; font-size:12px; }
    .btn.secondary{ border-color:#aaa; color:#555; }

    .kpi-grid{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; }
    .kpi{ background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px 12px; }
    .kpi .t{ font-size:12px; color:#666; margin:0; }
    .kpi .v{ font-size:20px; font-weight:800; margin:4px 0 0; color:#111; }
    /* 顏色：一般綠=正、紅=負；獲利類反轉（profit=紅正、綠負）由 JS 控制 class */
    .kpi .v.green{ color:#10b981; }
    .kpi .v.red{   color:#d32f2f; }
    .kpi .v.muted{ color:#666; }
    .note{ font-size:12px; color:#777; margin-top:6px; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

    /* 固定圖表高度，避免 canvas 無限延長 */
    .chartbox{ height:360px; }
    canvas{ width:100%; height:100%; background:#fff; border:1px solid #eee; border-radius:10px; }

    /* 表格樣式 */
    .simple-table{ width:100%; border-collapse:collapse; font-size:13px; }
    .simple-table th, .simple-table td{ border-bottom:1px solid #eee; padding:6px 8px; text-align:right; }
    .simple-table th:first-child, .simple-table td:first-child{ text-align:left; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1 style="margin-right:auto;">00909-ETF版本｜機構級 KPI</h1>
    <a class="home" href="index.html">← 回首頁</a>
  </div>
  <p class="sub">資料：Supabase <code>/reports</code> 最新「00909」檔；股票線獨立計算（不動期貨線）。</p>

  <div class="card">
    <div class="toolbar">
      <div id="meta" class="meta">正在抓取最新檔案…</div>
      <span style="flex:1;"></span>
      <a id="rawlink" class="btn" href="#" target="_blank" style="display:none;">查看原始 TXT</a>
      <a id="dl-raw"  class="btn secondary" href="#" download="00909_raw.txt" style="display:none;">下載原始 TXT</a>
    </div>
  </div>

  <!-- 建議投資方式 -->
  <div class="card">
    <h3>建議投資方式（本金 100 萬，單位規則 1-1-2）</h3>
    <table class="simple-table" id="planTbl">
      <tbody>
        <tr><th>最近一次買進時間</th><td id="plan-lastBuy">—</td></tr>
        <tr><th>當時買進價（元）</th><td id="plan-lastPx">—</td></tr>
        <tr><th>一張金額（元）</th><td id="plan-lotAmt">—</td></tr>
        <tr><th>極限可買張數（本金 ÷ 一張）</th><td id="plan-maxLots">—</td></tr>
        <tr><th>單位配置（1-1-2）</th><td id="plan-units">—</td></tr>
        <tr><th>計畫張數（合計）</th><td id="plan-planLots">—</td></tr>
        <tr><th>參考獲利（以最近完成一筆每張損益 × 計畫張數）</th><td id="plan-profit">—</td></tr>
      </tbody>
    </table>
    <div class="note">以最近一次「買進」的價格估算一張金額，先求極限張數，再用 1-1-2 的四單位配置（不足則捨去）。參考獲利以最近完成的一筆交易每張損益乘以計畫張數估算。</div>
  </div>

  <div class="card">
    <h3>核心績效</h3>
    <div id="kpi-core" class="kpi-grid"></div>
    <div class="note">報酬以「每 100 萬基準資金」表示；CAGR 於涵蓋日數 &gt; 365 才顯示。</div>
  </div>

  <div class="card">
    <h3>風險與風險調整</h3>
    <div id="kpi-risk" class="kpi-grid"></div>
    <div class="note">年化以 252 日；Calmar=CAGR/MDD；Ulcer 以 equity 百分比 drawdown 計算；VaR/CVaR 以日報酬左尾近似。</div>
  </div>

  <div class="card">
    <h3>交易層與執行品質</h3>
    <div id="kpi-trade" class="kpi-grid"></div>
    <div class="note">ISbps 由 decisionPx→execPx；MAE/MFE 取每筆交易（賣出行）；持有時間為分鐘。</div>
  </div>

  <div class="card">
    <h3>容量與參與率</h3>
    <div id="kpi-cap" class="kpi-grid"></div>
    <div class="note">參與率 ≈ entryNotional ÷ (ADV20 × 中位價)；僅作容量級距參考。</div>
  </div>

  <div class="card">
    <h3>收益曲線（每百萬 %）</h3>
    <div class="chartbox"><canvas id="eq"></canvas></div>
  </div>

  <div class="card grid2">
    <div>
      <h3>MAE vs MFE（散點，％）</h3>
      <div class="chartbox"><canvas id="maeMfe"></canvas></div>
    </div>
    <div>
      <h3>ISbps 分佈（直方）</h3>
      <div class="chartbox"><canvas id="isHist"></canvas></div>
    </div>
  </div>

  <div class="card">
    <h3>參與率曲線（按交易排序）</h3>
    <div class="chartbox"><canvas id="partRate"></canvas></div>
  </div>

  <!-- 交易摘要（全部顯示） -->
  <div class="card">
    <h3>交易摘要（全部顯示）</h3>
    <table class="simple-table" id="tblTrade">
      <thead>
        <tr>
          <th>筆數</th>
          <th>股票名稱</th>
          <th>成交日</th>
          <th>種類</th>
          <th>交易數量</th>
          <th>單價</th>
          <th>手續費</th>
          <th>付出成本</th>
          <th>損益</th>
          <th>獲利率</th>
          <th>累計損益</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <hr style="margin:12px 0;border:none;border-top:1px dashed #ddd;">
    <h4 style="margin:0 0 8px;">建議交易數量（本金100萬、1-1-2 規則）試算</h4>
    <table class="simple-table" id="tblPlan">
      <thead>
        <tr>
          <th>建議交易數量</th>
          <th>單價</th>
          <th>手續費(估)</th>
          <th>付出成本(估)</th>
          <th>損益試算</th>
          <th>獲利率</th>
          <th>累計損益(含試算)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- 依賴（股票線專用，不動期貨線） -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="etf-engine.js"></script>
<script src="etf-chart.js"></script>

<script>
(async function(){
  // ===== Supabase 設定 =====
  const SUPABASE_URL = "https://byhbmmnacezzgkwfkozs.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_xVe8fGbqQ0XGwi4DsmjPMg_Y2RBOD3t";
  const BUCKET = "reports";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    global: { fetch: (u,o={}) => fetch(u,{...o, cache:'no-store'}) }
  });

  const metaEl = document.getElementById('meta');
  const rawLink = document.getElementById('rawlink');
  const dlRaw  = document.getElementById('dl-raw');

  function pubUrl(path){ const { data } = sb.storage.from(BUCKET).getPublicUrl(path); return data?.publicUrl || '#'; }
  async function latest00909(){
    const { data, error } = await sb.storage.from(BUCKET).list('', { limit:1000, sortBy:{ column:'name', order:'asc' }});
    if (error) throw error;
    const files = (data||[]).filter(it => it.id !== null && /00909/i.test(it.name));
    if(!files.length) return null;
    const score = n => { const m=(n||'').match(/\b(20\d{6})\b/g); return m? Math.max(...m.map(s=>+s)):0; };
    files.sort((a,b)=>{
      const sa=score(a.name), sb=score(b.name);
      if(sa!==sb) return sb-sa;
      const ta=a.updated_at? Date.parse(a.updated_at):0, tb=b.updated_at? Date.parse(b.updated_at):0;
      if(ta!==tb) return tb-ta;
      return (b.metadata?.size||0)-(a.metadata?.size||0);
    });
    return files[0];
  }

  // —— 智慧解碼：utf-8 / big5 / utf-16le / utf-16be
  async function fetchSmart(url){
    const buf = await fetch(url, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.arrayBuffer(); });
    const encs = ['utf-8','big5','utf-16le','utf-16be'];
    for(const enc of encs){
      try{
        const td = new TextDecoder(enc, {fatal:false});
        const txt = td.decode(buf);
        const parsed = ETFEngine.parseEtfTxt(txt);
        if (parsed && parsed.trades && parsed.trades.length > 0) return { text: txt, enc, parsed };
      }catch(e){}
    }
    const txt = new TextDecoder('utf-8').decode(buf);
    return { text: txt, enc: 'utf-8', parsed: ETFEngine.parseEtfTxt(txt) };
  }

  // ── KPI 渲染輔助：支援「profit」反轉顏色（紅=賺、綠=虧）
  function putKPIs(targetId, items){
    const el=document.getElementById(targetId); el.innerHTML='';
    items.forEach(k=>{
      const d=document.createElement('div'); d.className='kpi';
      const t=document.createElement('p'); t.className='t'; t.textContent=k.label;
      const v=document.createElement('p'); v.className='v';
      v.textContent = k.fmt(k.value);
      if(typeof k.value==='number'){
        if(k.pos==='profit'){ v.classList.add(k.value>0?'red':(k.value<0?'green':'muted')); }
        else if(k.pos==='up'){ v.classList.add(k.value>0?'green':(k.value<0?'red':'muted')); }
        else if(k.pos==='down'){ v.classList.add(k.value<0?'green':(k.value>0?'red':'muted')); }
        else v.classList.add('muted');
      } else v.classList.add('muted');
      d.appendChild(t); d.appendChild(v); el.appendChild(d);
    });
  }
  const pct   = x => (x==null? '—' : (x*100).toFixed(2)+'%');
  const num   = x => (x==null? '—' : (+x).toFixed(2));
  const int   = x => (x==null? '—' : Math.round(+x).toString());
  const bps   = x => (x==null? '—' : (+x).toFixed(1)+' bps');
  const minFmt= x => (x==null? '—' : Math.round(+x)+' 分');

  try{
    metaEl.textContent = '正在抓取最新 00909 檔（/reports 下）…';

    // 1) 抓最新檔
    const latest = await latest00909();
    if(!latest){ metaEl.textContent='⚠️ 沒找到 00909 檔案（請確認 bucket/reports 是否有檔）。'; return; }
    const rawUrl = pubUrl(latest.name);
    rawLink.style.display='inline-block'; rawLink.href = rawUrl;

    // 2) 下載 + 智慧解碼 + 解析
    const { text:rawTxt, enc, parsed } = await fetchSmart(rawUrl);
    const rawBlob = new Blob([rawTxt], {type:'text/plain'});
    dlRaw.style.display='inline-block'; dlRaw.href = URL.createObjectURL(rawBlob);

    // 3) Loading → 成功
    const first = parsed.days[0] ? `${parsed.days[0].slice(0,4)}/${parsed.days[0].slice(4,6)}/${parsed.days[0].slice(6,8)}` : '—';
    const last  = parsed.days.length? `${parsed.days.at(-1).slice(0,4)}/${parsed.days.at(-1).slice(4,6)}/${parsed.days.at(-1).slice(6,8)}` : '—';
    metaEl.textContent = `✅ 已載入：${latest.name}（解碼：${enc}）｜交易筆數=${parsed.trades.length}｜期間：${first} ~ ${last}`;

    // 4) KPI 計算
    const kpis   = ETFEngine.calcEtfKpis(parsed);

    // 4.1 建議投資方式（本金 100 萬、單位 1-1-2）
    (function renderPlan(){
      const CAPITAL = 1_000_000;
      const lastBuyEv = [...parsed.events].filter(e=>e.action==='BUY').sort((a,b)=>a.ts.localeCompare(b.ts)).pop();
      const lastBuyTs = lastBuyEv ? `${lastBuyEv.d8.slice(0,4)}/${lastBuyEv.d8.slice(4,6)}/${lastBuyEv.d8.slice(6,8)} ${lastBuyEv.t6.slice(0,2)}:${lastBuyEv.t6.slice(2,4)}:${lastBuyEv.t6.slice(4,6)}` : '—';
      const buyPx = lastBuyEv ? +lastBuyEv.price : null;
      const lotAmt = buyPx ? Math.round(buyPx*1000) : null;
      const maxLots = lotAmt ? Math.floor(CAPITAL / lotAmt) : 0;
      const unitSize = maxLots ? Math.floor(maxLots / 4) : 0;  // 1-1-2
      const planLots = unitSize * 4;
      const unitsText = unitSize ? `${unitSize} / ${unitSize} / ${unitSize*2}` : '—';

      const lastTrade = [...parsed.trades].sort((a,b)=>a.tsOut.localeCompare(b.tsOut)).pop();
      const plPerLot = lastTrade ? (lastTrade.pxOut - lastTrade.pxIn) * 1000 : 0;
      const estProfit = planLots ? Math.round(plPerLot * planLots) : null;

      document.getElementById('plan-lastBuy').textContent = lastBuyTs;
      document.getElementById('plan-lastPx').textContent  = buyPx!=null ? buyPx.toFixed(2) : '—';
      document.getElementById('plan-lotAmt').textContent  = lotAmt!=null ? lotAmt.toLocaleString() : '—';
      document.getElementById('plan-maxLots').textContent = maxLots || '—';
      document.getElementById('plan-units').textContent   = unitsText;
      document.getElementById('plan-planLots').textContent= planLots || '—';
      document.getElementById('plan-profit').textContent  = (estProfit!=null) ? (estProfit>=0? `+${estProfit.toLocaleString()} 元` : `${estProfit.toLocaleString()} 元`) : '—';
    })();

    // 5) KPI 顯示（獲利類用 pos:'profit' → 紅=賺、綠=虧）
    putKPIs('kpi-core', [
      {label:'累積報酬（每百萬）', value:kpis.core.totalReturn, fmt:pct, pos:'profit'},
      {label:'CAGR',              value:kpis.core.CAGR,        fmt:pct, pos:'profit'},
      {label:'涵蓋日數',           value:kpis.core.coverDays,   fmt:int, pos:null},
      {label:'交易筆數',           value:kpis.core.trades,      fmt:int, pos:null},
    ]);

    putKPIs('kpi-risk', [
      {label:'年化波動',  value:kpis.risk.volAnn,   fmt:pct, pos:'down'},
      {label:'最大回撤',  value:kpis.risk.MDD,      fmt:pct, pos:'down'},
      {label:'回撤持續（日）', value:kpis.risk.ddDuration, fmt:int, pos:null},
      {label:'Ulcer Index', value:(kpis.risk.UlcerIndex/100), fmt:pct, pos:'down'},
      {label:'Sharpe',     value:kpis.risk.Sharpe,   fmt:num, pos:'profit'},
      {label:'Sortino',    value:kpis.risk.Sortino,  fmt:num, pos:'profit'},
      {label:'Calmar',     value:kpis.risk.Calmar,   fmt:num, pos:'profit'},
      {label:'VaR(95%) / 日',  value:kpis.risk.VaR95,  fmt:pct, pos:'down'},
      {label:'CVaR(95%) / 日', value:kpis.risk.CVaR95, fmt:pct, pos:'down'},
    ]);

    putKPIs('kpi-trade', [
      {label:'勝率',              value:kpis.trade.winRate,   fmt:pct,  pos:'profit'},
      {label:'Profit Factor',    value:kpis.trade.PF,        fmt:num,  pos:'profit'},
      {label:'均單報酬（每筆/百萬）', value:kpis.trade.avgTrade, fmt:pct,  pos:'profit'},
      {label:'平均持有時間',     value:kpis.trade.avgHoldMin,fmt:minFmt,pos:null},
      {label:'中位持有時間',     value:kpis.trade.medHoldMin,fmt:minFmt,pos:null},
      {label:'平均 MAE',         value:kpis.trade.avgMAEpct/100, fmt:pct, pos:'down'},
      {label:'平均 MFE',         value:kpis.trade.avgMFEpct/100, fmt:pct, pos:'profit'},
      {label:'平均 ISbps',       value:kpis.trade.avgISbps,  fmt:bps,  pos:'down'},
    ]);

    putKPIs('kpi-cap', [
      {label:'平均參與率',  value:kpis.capacity.avgParticipation, fmt:pct, pos:'down'},
      {label:'P75 參與率',  value:kpis.capacity.p75Participation, fmt:pct, pos:'down'},
      {label:'基準資金（萬）', value:kpis.meta.baseCapital/10000, fmt:num, pos:null},
      {label:'涵蓋期間(起-迄)', value:0, fmt:()=>((kpis.meta.firstDay||'—')+' ~ '+(kpis.meta.lastDay||'—')), pos:null},
    ]);

    // 6) 圖表
    const labels = parsed.days.map(d=>`${d.slice(0,4)}/${d.slice(4,6)}/${d.slice(6,8)}`);
    ETFChart.drawEquityCurve(document.getElementById('eq'), labels, parsed.equity);
    const MAEs  = parsed.trades.map(t=> t.maePct!=null ? +t.maePct : null).filter(x=>x!=null);
    const MFEs  = parsed.trades.map(t=> t.mfePct!=null ? +t.mfePct : null).filter(x=>x!=null);
    ETFChart.drawMaeMfeScatter(document.getElementById('maeMfe'), MAEs, MFEs);
    const ISbps = parsed.trades.map(t=> t.ISbps!=null ? +t.ISbps : null).filter(x=>x!=null);
    ETFChart.drawIsHist(document.getElementById('isHist'), ISbps, 24);
    const partRates = parsed.trades.map(t=>{
      if (t.entryNotionalSum && t.ADV20avg && t.medExecPx) {
        const est = t.ADV20avg * t.medExecPx;
        return est>0 ? (t.entryNotionalSum / est) : null;
      }
      return null;
    }).filter(x=>x!=null);
    ETFChart.drawPartRate(document.getElementById('partRate'), partRates);

    // 7) 交易摘要（全部顯示，新格式）
    {
      const STOCK_NAME = '00909';
      const tbody = document.querySelector('#tblTrade tbody');

      // 建 SELL kv 索引
      const sellKVByTid = {};
      for (const ev of parsed.events) if (ev.action === 'SELL') sellKVByTid[String(ev.kv.tid)] = ev.kv;

      let accGain = 0; // 累計損益（元）
      const rows = parsed.trades
        .sort((a,b)=> a.tsOut.localeCompare(b.tsOut))
        .map((t, idx) => {
          const kv = sellKVByTid[String(t.tid)] || {};
          const d8 = String(t.tsOut).slice(0,8);
          const dstr = `${d8.slice(0,4)}${d8.slice(4,6)}${d8.slice(6,8)}`;
          const qtyShares = t.qty * 1000;
          const px = +t.pxOut || 0;
          const feeSell = kv['賣手續費'] != null ? Number(kv['賣手續費']) : 0;
          const avgCostWithFee = kv['平均成本含稅'] != null ? Number(kv['平均成本含稅']) : (t.pxInAvg || 0);
          const costPay = Math.round(avgCostWithFee * qtyShares);
          const gainNet = Math.round(t.gainSlip || 0);
          accGain += gainNet;
          const roi = costPay > 0 ? gainNet / costPay : 0;
          const color = gainNet > 0 ? 'style="color:#d32f2f;font-weight:700;"'
                        : (gainNet < 0 ? 'style="color:#10b981;font-weight:700;"' : '');
          return `<tr>
            <td>${idx+1}</td>
            <td>${STOCK_NAME}</td>
            <td>${dstr}</td>
            <td>賣出</td>
            <td>${qtyShares.toLocaleString()}</td>
            <td>${px.toFixed(2)}</td>
            <td>${feeSell ? feeSell.toLocaleString() : ''}</td>
            <td>${costPay ? costPay.toLocaleString() : ''}</td>
            <td ${color}>${gainNet>=0?'+':''}${(gainNet).toLocaleString()}</td>
            <td ${color}>${(roi*100).toFixed(2)}%</td>
            <td ${color}>${accGain>=0?'+':''}${accGain.toLocaleString()}</td>
          </tr>`;
        });

      tbody.innerHTML = rows.join('') || '<tr><td colspan="11" style="text-align:center;color:#777;">（無資料）</td></tr>';

      // 8) 建議交易數量試算（本金100萬、1-1-2）
      const planBody = document.querySelector('#tblPlan tbody');
      const CAPITAL = 1_000_000;
      const lastBuyEv = [...parsed.events].filter(e=>e.action==='BUY').sort((a,b)=>a.ts.localeCompare(b.ts)).pop();
      const lastTrade = [...parsed.trades].sort((a,b)=>a.tsOut.localeCompare(b.tsOut)).pop();

      const buyPx = lastBuyEv ? +lastBuyEv.price : null;
      const lotAmt = buyPx ? Math.round(buyPx*1000) : null;
      const maxLots = lotAmt ? Math.floor(CAPITAL / lotAmt) : 0;
      const unitSize = maxLots ? Math.floor(maxLots / 4) : 0;
      const planLots = unitSize * 4;

      const FEE_PER_LOT_EST = 59;                             // 估算：59/張（可改）
      const planFee  = planLots * FEE_PER_LOT_EST;
      const planCost = buyPx ? Math.round(planLots * 1000 * buyPx) + planFee : null;

      const plPerLot = lastTrade ? (lastTrade.pxOut - lastTrade.pxIn) * 1000 : 0; // 元/張
      const planGain = Math.round(plPerLot * planLots);
      const planRoi  = planCost>0 ? planGain / planCost : 0;
      const planAcc  = (accGain + planGain);
      const c = gain => (gain>0 ? 'style="color:#d32f2f;font-weight:700;"' : (gain<0 ? 'style="color:#10b981;font-weight:700;"' : ''));

      planBody.innerHTML = `<tr>
        <td>${planLots || '—'} 張</td>
        <td>${buyPx!=null ? buyPx.toFixed(2) : '—'}</td>
        <td>${planLots ? (planFee.toLocaleString()) : '—'}</td>
        <td>${planCost!=null ? planCost.toLocaleString() : '—'}</td>
        <td ${c(planGain)}>${planGain>=0?'+':''}${planGain.toLocaleString()}</td>
        <td ${c(planRoi)}>${(planRoi*100).toFixed(2)}%</td>
        <td ${c(planAcc)}>${planAcc>=0?'+':''}${planAcc.toLocaleString()}</td>
      </tr>`;
    }
  }catch(err){
    metaEl.textContent = '❌ 載入或解析失敗：' + (err?.message || err);
    console.error(err);
  }
})();
</script>
</body>
</html>
