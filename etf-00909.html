<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>00909-ETF版本｜機構級 KPI</title>
<style>
  :root{ --w:1100px; --r:12px; }
  body{ font-family: Arial,"微軟正黑體",sans-serif; margin:20px; background:#f8f9fa; color:#333; }
  h1{ margin:0 0 6px 0; font-weight:800; letter-spacing:.5px; }
  .sub{ color:#666; margin:0 0 18px 0; font-size:14px; }
  .wrap{ max-width:var(--w); margin:0 auto; }
  .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .home{ display:inline-block; padding:6px 10px; border-radius:10px; border:1px solid #aaa; color:#333; text-decoration:none; font-size:12px; }
  .home:hover{ background:#f2f2f2; }
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:var(--r); box-shadow:0 2px 8px rgba(0,0,0,.06); padding:16px 18px; margin:14px 0; }
  .card.wide{ /* 只有交易明細滿寬顯示 */
    width:100vw; margin-left:calc(50% - 50vw); padding-left:24px; padding-right:24px;
  }
  .meta{ color:#666; font-size:12px; }
  .btn{ display:inline-block; padding:6px 10px; border-radius:10px; border:1px solid #0d6efd; color:#0d6efd; text-decoration:none; font-size:12px; }
  .btn.secondary{ border-color:#aaa; color:#555; }

  .kpi-grid{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; }
  .kpi{ background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px 12px; }
  .kpi .t{ font-size:12px; color:#666; margin:0; }
  .kpi .v{ font-size:20px; font-weight:800; margin:4px 0 0; color:#111; }
  .kpi .v.green{ color:#10b981; }  /* 一般正向 */
  .kpi .v.red{   color:#d32f2f; }  /* 獲利：正 → 紅 */
  .kpi .v.muted{ color:#666; }
  .note{ font-size:12px; color:#777; margin-top:6px; }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }

  .chartbox{ height:360px; }
  canvas{ width:100%; height:100%; background:#fff; border:1px solid #eee; border-radius:10px; }

  /* 交易明細緊縮：較小字、較小 padding、不換行；欄數多但不會跳行 */
  .simple-table{ width:100%; min-width:2600px; border-collapse:collapse; font-size:12px; }
  .simple-table th, .simple-table td{ border-bottom:1px solid #eee; padding:4px 6px; text-align:right; white-space:nowrap; }
  .simple-table th:first-child, .simple-table td:first-child{ text-align:left; }
  .row-buy{  background:#fdecea; }  /* 買進：淡紅底 */
  .row-sell{ background:#e9f8ef; }  /* 賣出：淡綠底 */
  .gain-red{ color:#d32f2f; font-weight:700; }
  .loss-green{ color:#10b981; font-weight:700; }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1 style="margin-right:auto;">00909-ETF版本｜機構級 KPI</h1>
    <a class="home" href="index.html">← 回首頁</a>
  </div>
  <p class="sub">資料：Supabase <code>/reports</code> 最新「00909」檔；股票線獨立計算（不動期貨線）。</p>

  <div class="card">
    <div class="toolbar">
      <div id="meta" class="meta">正在抓取最新檔案…</div>
      <span style="flex:1;"></span>
      <a id="rawlink" class="btn" href="#" target="_blank" style="display:none;">查看原始 TXT</a>
      <a id="dl-raw"  class="btn secondary" href="#" download="00909_raw.txt" style="display:none;">下載原始 TXT</a>
    </div>
  </div>

  <div class="card">
    <h3>建議投資方式（本金 100 萬，單位規則 1-1-2）</h3>
    <table class="simple-table">
      <tbody>
        <tr><th>最近一次買進時間</th><td id="plan-lastBuy">—</td></tr>
        <tr><th>當時買進價（元）</th><td id="plan-lastPx">—</td></tr>
        <tr><th>一張金額（元）</th><td id="plan-lotAmt">—</td></tr>
        <tr><th>極限可買張數（本金 ÷ 一張）</th><td id="plan-maxLots">—</td></tr>
        <tr><th>單位配置（1-1-2）</th><td id="plan-units">—</td></tr>
        <tr><th>計畫張數（合計）</th><td id="plan-planLots">—</td></tr>
        <tr><th>參考獲利（最近完成一筆每張損益 × 計畫張數）</th><td id="plan-profit">—</td></tr>
      </tbody>
    </table>
  </div>

  <!-- KPI 區（保留原樣） -->
  <div class="card"><h3>核心績效</h3><div id="kpi-core" class="kpi-grid"></div></div>
  <div class="card"><h3>風險與風險調整</h3><div id="kpi-risk" class="kpi-grid"></div></div>
  <div class="card"><h3>交易層與執行品質</h3><div id="kpi-trade" class="kpi-grid"></div></div>
  <div class="card"><h3>容量與參與率</h3><div id="kpi-cap" class="kpi-grid"></div></div>

  <!-- 圖表 -->
  <div class="card"><h3>收益曲線（每百萬 %）</h3><div class="chartbox"><canvas id="eq"></canvas></div></div>
  <div class="card grid2">
    <div><h3>MAE vs MFE（散點，％）</h3><div class="chartbox"><canvas id="maeMfe"></canvas></div></div>
    <div><h3>ISbps 分佈（直方）</h3><div class="chartbox"><canvas id="isHist"></canvas></div></div>
  </div>
</div>

<!-- 交易明細（滿寬展示） -->
<div class="card wide">
  <h3>交易明細</h3>
  <table class="simple-table" id="tblTrade">
    <thead>
      <tr>
        <th>筆數</th><th>股票名稱</th><th>成交日</th><th>種類</th><th>交易數量</th><th>單價</th><th>手續費</th>
        <th>買進金額</th><th>賣出金額</th>
        <th>損益</th><th>獲利率</th><th>累計損益</th>
        <th style="border-left:2px solid #ddd;">建議交易數量</th><th>單價</th><th>手續費(估)</th>
        <th>買進金額(估)</th><th>賣出金額(估)</th>
        <th>損益試算</th><th>獲利率</th><th>累計損益(含試算)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- 依賴 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="etf-engine.js"></script>
<script src="etf-chart.js"></script>

<script>
(async function(){
  const SUPABASE_URL="https://byhbmmnacezzgkwfkozs.supabase.co";
  const SUPABASE_ANON_KEY="sb_publishable_xVe8fGbqQ0XGwi4DsmjPMg_Y2RBOD3t";
  const BUCKET="reports";
  const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{global:{fetch:(u,o={})=>fetch(u,{...o,cache:'no-store'})}});

  const metaEl=document.getElementById('meta');
  const rawLink=document.getElementById('rawlink');
  const dlRaw=document.getElementById('dl-raw');

  function pubUrl(p){const{data}=sb.storage.from(BUCKET).getPublicUrl(p);return data?.publicUrl||'#';}
  async function latest00909(){
    const {data,error}=await sb.storage.from(BUCKET).list('',{limit:1000,sortBy:{column:'name',order:'asc'}});
    if(error) throw error;
    const files=(data||[]).filter(it=>it.id!==null && /00909/i.test(it.name));
    if(!files.length) return null;
    files.sort((a,b)=> b.name.localeCompare(a.name));
    return files[0];
  }
  async function fetchSmart(url){
    const buf=await fetch(url,{cache:'no-store'}).then(r=>{if(!r.ok) throw new Error(r.status+' '+r.statusText);return r.arrayBuffer();});
    const encs=['utf-8','big5','utf-16le','utf-16be'];
    for(const enc of encs){
      try{
        const td=new TextDecoder(enc,{fatal:false});
        const txt=td.decode(buf);
        const parsed=ETFEngine.parseEtfTxt(txt);
        if(parsed && parsed.trades && parsed.trades.length>0) return {txt,enc,parsed};
      }catch(e){}
    }
    const txt=new TextDecoder('utf-8').decode(buf);
    return {txt,enc:'utf-8',parsed:ETFEngine.parseEtfTxt(txt)};
  }

  // KPI 文字顏色（profit=紅/虧=綠）
  function putKPIs(id, items){
    const el=document.getElementById(id); el.innerHTML='';
    items.forEach(k=>{
      const d=document.createElement('div'); d.className='kpi';
      const t=document.createElement('p'); t.className='t'; t.textContent=k.label;
      const v=document.createElement('p'); v.className='v'; v.textContent=k.fmt(k.value);
      if(typeof k.value==='number'){
        if(k.pos==='profit'){ v.classList.add(k.value>0?'red':(k.value<0?'green':'muted')); }
        else if(k.pos==='up'){ v.classList.add(k.value>0?'green':(k.value<0?'red':'muted')); }
        else if(k.pos==='down'){ v.classList.add(k.value<0?'green':(k.value>0?'red':'muted')); }
        else v.classList.add('muted');
      } else v.classList.add('muted');
      d.appendChild(t); d.appendChild(v); el.appendChild(d);
    });
  }
  const pct=x=>(x==null?'—':(x*100).toFixed(2)+'%');
  const num=x=>(x==null?'—':(+x).toFixed(2));
  const int=x=>(x==null?'—':Math.round(+x).toString());

  // 依法計算（ETF：佣金 0.1425%，每筆最低 20；證交稅 0.1% 僅賣出）
  const FEE_RATE = 0.001425;
  const FEE_MIN  = 20;
  const TAX_RATE = 0.001; // ETF 0.1%

  function fee(amount){ // 以元為單位，四捨五入至元
    return Math.max(Math.round(amount * FEE_RATE), FEE_MIN);
  }
  function taxOnSell(amount){ return Math.round(amount * TAX_RATE); }

  try{
    metaEl.textContent='正在抓取最新 00909 檔…';
    const latest=await latest00909();
    if(!latest){ metaEl.textContent='⚠️ 沒找到 00909 檔案。'; return; }
    const rawUrl=pubUrl(latest.name); rawLink.style.display='inline-block'; rawLink.href=rawUrl;

    const {txt:rawTxt,enc,parsed}=await fetchSmart(rawUrl);
    const blob=new Blob([rawTxt],{type:'text/plain'}); dlRaw.style.display='inline-block'; dlRaw.href=URL.createObjectURL(blob);

    const first = parsed.days[0]? `${parsed.days[0].slice(0,4)}/${parsed.days[0].slice(4,6)}/${parsed.days[0].slice(6,8)}` : '—';
    const last  = parsed.days.length? `${parsed.days.at(-1).slice(0,4)}/${parsed.days.at(-1).slice(4,6)}/${parsed.days.at(-1).slice(6,8)}` : '—';
    metaEl.textContent = `✅ 已載入：${latest.name}（解碼：${enc}）｜交易筆數=${parsed.trades.length}｜期間：${first} ~ ${last}`;

    // KPI
    const kpis=ETFEngine.calcEtfKpis(parsed);
    putKPIs('kpi-core', [
      {label:'累積報酬（每百萬）', value:kpis.core.totalReturn, fmt:pct, pos:'profit'},
      {label:'CAGR',              value:kpis.core.CAGR,        fmt:pct, pos:'profit'},
      {label:'涵蓋日數',           value:kpis.core.coverDays,   fmt:int, pos:null},
      {label:'交易筆數',           value:kpis.core.trades,      fmt:int, pos:null},
    ]);
    putKPIs('kpi-risk', [
      {label:'年化波動',  value:kpis.risk.volAnn,   fmt:pct, pos:'down'},
      {label:'最大回撤',  value:kpis.risk.MDD,      fmt:pct, pos:'down'},
      {label:'回撤持續（日）', value:kpis.risk.ddDuration, fmt:int, pos:null},
      {label:'Ulcer Index', value:(kpis.risk.UlcerIndex/100), fmt:pct, pos:'down'},
      {label:'Sharpe',     value:kpis.risk.Sharpe,   fmt:num, pos:'profit'},
      {label:'Sortino',    value:kpis.risk.Sortino,  fmt:num, pos:'profit'},
      {label:'Calmar',     value:kpis.risk.Calmar,   fmt:num, pos:'profit'},
      {label:'VaR(95%) / 日',  value:kpis.risk.VaR95,  fmt:pct, pos:'down'},
      {label:'CVaR(95%) / 日', value:kpis.risk.CVaR95, fmt:pct, pos:'down'},
    ]);

    // 圖表
    const labels=parsed.days.map(d=>`${d.slice(0,4)}/${d.slice(4,6)}/${d.slice(6,8)}`);
    ETFChart.drawEquityCurve(document.getElementById('eq'), labels, parsed.equity);
    const MAEs=parsed.trades.map(t=> t.maePct!=null? +t.maePct : null).filter(Boolean);
    const MFEs=parsed.trades.map(t=> t.mfePct!=null? +t.mfePct : null).filter(Boolean);
    ETFChart.drawMaeMfeScatter(document.getElementById('maeMfe'), MAEs, MFEs);
    const ISbps=parsed.trades.map(t=> t.ISbps!=null? +t.ISbps : null).filter(Boolean);
    ETFChart.drawIsHist(document.getElementById('isHist'), ISbps, 24);

    // 建議投資方式（卡片）
    (function(){
      const CAPITAL=1_000_000;
      const lastBuy=[...parsed.events].filter(e=>e.action==='BUY').sort((a,b)=>a.ts.localeCompare(b.ts)).pop();
      const lastBuyTs = lastBuy? `${lastBuy.d8.slice(0,4)}/${lastBuy.d8.slice(4,6)}/${lastBuy.d8.slice(6,8)} ${lastBuy.t6.slice(0,2)}:${lastBuy.t6.slice(2,4)}:${lastBuy.t6.slice(4,6)}` : '—';
      const px = lastBuy? +lastBuy.price : null;
      const oneLot = px? Math.round(px*1000 + fee(px*1000)) : null;
      const maxLots = oneLot? Math.floor(CAPITAL/oneLot) : 0;
      const unit = maxLots? Math.floor(maxLots/4) : 0;
      const planLots = unit*4;
      const lastTr=[...parsed.trades].sort((a,b)=>a.tsOut.localeCompare(b.tsOut)).pop();
      const per = lastTr ? (lastTr.pxOut-lastTr.pxIn)*1000 : 0;
      const refProfit = Math.round(per * planLots);

      document.getElementById('plan-lastBuy').textContent= lastBuyTs;
      document.getElementById('plan-lastPx').textContent  = px!=null? px.toFixed(2) : '—';
      document.getElementById('plan-lotAmt').textContent  = oneLot!=null? oneLot.toLocaleString() : '—';
      document.getElementById('plan-maxLots').textContent = maxLots || '—';
      document.getElementById('plan-units').textContent   = unit? `${unit} / ${unit} / ${unit*2}` : '—';
      document.getElementById('plan-planLots').textContent= planLots || '—';
      document.getElementById('plan-profit').textContent  = (refProfit>=0?'+':'') + (refProfit||0).toLocaleString() + ' 元';
    })();

    // ===== 交易明細（依法計算手續費/稅；建議數量按 1-1-2；SELL 取同 tid 累計建議） =====
    const tbody=document.querySelector('#tblTrade tbody');
    const STOCK='00909'; const CAPITAL=1_000_000;

    const tradeByTid={}; parsed.trades.forEach(t=> tradeByTid[String(t.tid)]=t);
    const suggBuyLotsByTid={}; // SELL 使用：同 tid 之前 BUY/ADD 累計的「建議買進張數」
    let accGain=0;             // 累計實際損益（元）

    const rows = parsed.events
      .filter(e=>['BUY','ADD1','ADD2','SELL'].includes(e.action))
      .sort((a,b)=> a.ts.localeCompare(b.ts))
      .map((e,idx)=>{
        const isSell = e.action==='SELL';
        const cls = isSell? 'row-sell' : 'row-buy';

        const px = +e.price || 0;
        // 事件原始張數（顯示用）
        const lotsRaw = isSell
          ? (e.kv['總單位']!=null ? +e.kv['總單位'] : (tradeByTid[e.kv.tid]?.qty || 1))
          : (e.kv['本次單位']!=null ? +e.kv['本次單位'] : 1);
        const qtyRaw = lotsRaw * 1000;

        // 依法手續費/稅 & 實際淨額（顯示「買進金額／賣出金額」）
        const grossRaw = px * qtyRaw;
        const feeRaw   = fee(grossRaw);
        const buyAmt   = !isSell ? Math.round(grossRaw + feeRaw) : null;
        const sellAmt  =  isSell ? Math.round(grossRaw - feeRaw - taxOnSell(grossRaw)) : null;

        // 實際損益 / ROI（僅 SELL 列）
        let gain=null, roi=null, accHtml='';
        if (isSell){
          const tr=tradeByTid[e.kv.tid];
          gain = Math.round(tr.gainSlip || 0);
          const baseCost = Math.round((tr.pxInAvg||0) * qtyRaw);
          roi = baseCost ? (gain / baseCost) : 0;
          accGain += gain;
          accHtml = `<span class="${accGain>=0?'gain-red':'loss-green'}">${accGain>=0?'+':''}${accGain.toLocaleString()}</span>`;
        }

        // 建議張數（1-1-2）：用當列單價推估單位大小，SELL=同 tid 累計的建議買進張數
        const oneLotEst  = Math.round(px*1000 + fee(px*1000));
        const maxLotsEst = oneLotEst>0 ? Math.floor(CAPITAL/oneLotEst) : 0;
        const unitSize   = maxLotsEst? Math.floor(maxLotsEst/4) : 0;

        let suggLots = 0;
        if (e.action==='BUY' || e.action==='ADD1')      suggLots = unitSize;
        else if (e.action==='ADD2')                     suggLots = unitSize*2;
        else if (e.action==='SELL')                     suggLots = (suggBuyLotsByTid[e.kv.tid] || 0);

        if (!isSell){ // 先記錄（供 SELL 使用）
          suggBuyLotsByTid[e.kv.tid] = (suggBuyLotsByTid[e.kv.tid] || 0) + suggLots;
        }

        const qtySugg = suggLots * 1000;
        const grossBuyEst  = px * qtySugg;
        const grossSellEst = px * qtySugg;
        const feeBuyEst    = fee(grossBuyEst);
        const feeSellEst   = fee(grossSellEst);
        const taxEst       = taxOnSell(grossSellEst);

        const buyAmtEst  = Math.round(grossBuyEst  + feeBuyEst);
        const sellAmtEst = Math.round(grossSellEst - feeSellEst - taxEst);

        // 損益試算（只在 SELL 列；用該 tid 的 pxInAvg 作為估買入價格）
        let planGain=null, planRoi=null, planAcc=null;
        if (isSell){
          const tr=tradeByTid[e.kv.tid];
          if (tr){
            // 估買進淨額用 pxInAvg
            const grossBuyAvg  = (tr.pxInAvg||0) * qtySugg;
            const feeBuyAvg    = fee(grossBuyAvg);
            const buyNetAvg    = Math.round(grossBuyAvg + feeBuyAvg);
            const sellNet      = sellAmtEst;
            planGain = (sellNet - buyNetAvg);
            planRoi  = buyNetAvg ? (planGain / buyNetAvg) : 0;
            planAcc  = accGain + planGain;
          }
        }

        const d8=e.d8;
        const gainHtml = (gain==null)? '' : (gain>=0? `<span class="gain-red">+${gain.toLocaleString()}</span>` : `<span class="loss-green">${gain.toLocaleString()}</span>`);
        const roiHtml  = (roi==null)? '' : (roi>=0? `<span class="gain-red">${(roi*100).toFixed(2)}%</span>` : `<span class="loss-green">${(roi*100).toFixed(2)}%</span>`);
        const planGainHtml = (planGain==null)? '' : (planGain>=0? `<span class="gain-red">+${planGain.toLocaleString()}</span>` : `<span class="loss-green">${planGain.toLocaleString()}</span>`);
        const planRoiHtml  = (planRoi==null)? '' : (planRoi>=0? `<span class="gain-red">${(planRoi*100).toFixed(2)}%</span>` : `<span class="loss-green">${(planRoi*100).toFixed(2)}%</span>`);
        const planAccHtml  = (planAcc==null)? '' : (planAcc>=0? `<span class="gain-red">+${planAcc.toLocaleString()}</span>` : `<span class="loss-green">${planAcc.toLocaleString()}</span>`);

        return `<tr class="${cls}">
          <td>${idx+1}</td>
          <td>${STOCK}</td>
          <td>${d8}</td>
          <td>${isSell?'賣出':'買進'}</td>
          <td>${qtyRaw.toLocaleString()}</td>
          <td>${px.toFixed(2)}</td>
          <td>${feeRaw.toLocaleString()}</td>
          <td>${buyAmt!=null? buyAmt.toLocaleString(): ''}</td>
          <td>${sellAmt!=null? sellAmt.toLocaleString(): ''}</td>
          <td>${gainHtml}</td>
          <td>${roiHtml}</td>
          <td>${accHtml}</td>
          <td style="border-left:2px solid #ddd;">${suggLots || ''}</td>
          <td>${px? px.toFixed(2): ''}</td>
          <td>${suggLots? feeSellEst.toLocaleString(): ''}</td>
          <td>${suggLots? buyAmtEst.toLocaleString(): ''}</td>
          <td>${suggLots? sellAmtEst.toLocaleString(): ''}</td>
          <td>${planGainHtml}</td>
          <td>${planRoiHtml}</td>
          <td>${planAccHtml}</td>
        </tr>`;
      });

    document.querySelector('#tblTrade tbody').innerHTML =
      rows.join('') || '<tr><td colspan="20" style="text-align:center;color:#777;">（無資料）</td></tr>';

  }catch(err){
    metaEl.textContent='❌ 載入或解析失敗：'+(err?.message||err);
    console.error(err);
  }
})();
</script>
</body>
</html>
