<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>00909-ETF版本｜機構級 KPI</title>
<style>
:root{--r:12px;}
body{font-family:Arial,"微軟正黑體",sans-serif;margin:20px;background:#f8f9fa;color:#333;}
h1{margin:0 0 6px 0;font-weight:800;}
.wrap{max-width:1100px;margin:0 auto;}
.toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.home{display:inline-block;padding:6px 10px;border-radius:10px;border:1px solid #aaa;color:#333;text-decoration:none;font-size:12px;}
.home:hover{background:#f2f2f2;}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:var(--r);box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px 18px;margin:14px 0;}
.card.wide{width:100vw;margin-left:calc(50% - 50vw);padding-left:24px;padding-right:24px;}
.simple-table{width:100%;min-width:2300px;border-collapse:collapse;font-size:13px;}
.simple-table th,.simple-table td{border-bottom:1px solid #eee;padding:6px 8px;text-align:right;white-space:nowrap;}
.simple-table th:first-child,.simple-table td:first-child{text-align:left;}
.row-buy{background:#fdecea;}
.row-sell{background:#e9f8ef;}
.gain-red{color:#d32f2f;font-weight:700;}
.loss-green{color:#10b981;font-weight:700;}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1 style="margin-right:auto;">00909-ETF版本｜機構級 KPI</h1>
    <a class="home" href="index.html">← 回首頁</a>
  </div>
</div>

<div class="card wide">
<h3>交易明細</h3>
<table class="simple-table" id="tblTrade">
<thead>
<tr>
<th>筆數</th><th>股票名稱</th><th>成交日</th><th>種類</th><th>交易數量</th><th>單價</th><th>手續費</th>
<th>買進金額</th><th>賣出金額</th>
<th>損益</th><th>獲利率</th><th>累計損益</th>
<th style="border-left:2px solid #ddd;">建議交易數量</th><th>單價</th><th>手續費(估)</th>
<th>買進金額(估)</th><th>賣出金額(估)</th>
<th>損益試算</th><th>獲利率</th><th>累計損益(含試算)</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="etf-engine.js"></script>

<script>
(async function(){
const SUPABASE_URL="https://byhbmmnacezzgkwfkozs.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_xVe8fGbqQ0XGwi4DsmjPMg_Y2RBOD3t";
const BUCKET="reports";
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{global:{fetch:(u,o={})=>fetch(u,{...o,cache:'no-store'})}});

function pubUrl(p){const{data}=sb.storage.from(BUCKET).getPublicUrl(p);return data?.publicUrl||'#';}
async function latest00909(){
const{data}=await sb.storage.from(BUCKET).list('',{limit:1000,sortBy:{column:'name',order:'asc'}});
const f=(data||[]).filter(it=>/00909/i.test(it.name));if(!f.length)return null;
f.sort((a,b)=>b.name.localeCompare(a.name));return f[0];
}
async function fetchSmart(u){
const b=await fetch(u,{cache:'no-store'}).then(r=>r.arrayBuffer());
const td=new TextDecoder('utf-8');return ETFEngine.parseEtfTxt(td.decode(b));
}

const latest=await latest00909();if(!latest)return;
const rawUrl=pubUrl(latest.name);const parsed=await fetchSmart(rawUrl);

const tbody=document.querySelector('#tblTrade tbody');
const FEE_PER_LOT_EST=59;const CAPITAL=1_000_000;
const tradeByTid={};parsed.trades.forEach(t=>tradeByTid[t.tid]=t);

let accGain=0;
const rows=parsed.events.filter(e=>['BUY','ADD1','ADD2','SELL'].includes(e.action))
.sort((a,b)=>a.ts.localeCompare(b.ts)).map((e,i)=>{
const isSell=e.action==='SELL';
const cls=isSell?'row-sell':'row-buy';
const px=+e.price||0;
const lots=e.kv['本次單位']?+e.kv['本次單位']:1;
const qty=lots*1000;
const fee=isSell?(+e.kv['賣手續費']||0):(+e.kv['買手續費']||lots*FEE_PER_LOT_EST);
const buyAmt=!isSell?Math.round(px*qty+fee):null;
const sellAmt=isSell?Math.round(px*qty-fee):null;
let gain=null,roi=null;
if(isSell){const t=tradeByTid[e.kv.tid];
gain=Math.round(t.gainSlip||0);
const base=(t.pxInAvg||0)*qty;
roi=base?gain/base:0;accGain+=gain;}
const lotCost=Math.round(px*1000+FEE_PER_LOT_EST);
const maxLots=Math.floor(CAPITAL/lotCost);
const unit=Math.floor(maxLots/4);
let sugg=0;if(e.action==='BUY'||e.action==='ADD1')sugg=unit;
else if(e.action==='ADD2')sugg=unit*2;
else if(e.action==='SELL')sugg=unit*4;
const planFee=sugg*FEE_PER_LOT_EST;
const planBuyAmt=Math.round(sugg*1000*px+planFee);
const planSellAmt=Math.round(sugg*1000*px-planFee);
let planGain=null,planRoi=null,planAcc=null;
if(isSell){const t=tradeByTid[e.kv.tid];
const per=(t.pxOut-t.pxIn)*1000;
planGain=Math.round(per*sugg);
planRoi=planBuyAmt?planGain/planBuyAmt:0;
planAcc=accGain+planGain;}
return `<tr class="${cls}">
<td>${i+1}</td><td>00909</td><td>${e.d8}</td><td>${isSell?'賣出':'買進'}</td>
<td>${qty.toLocaleString()}</td><td>${px.toFixed(2)}</td><td>${fee}</td>
<td>${buyAmt?buyAmt.toLocaleString():''}</td><td>${sellAmt?sellAmt.toLocaleString():''}</td>
<td>${gain!=null?(gain>=0?`<span class='gain-red'>+${gain}</span>`:`<span class='loss-green'>${gain}</span>`):''}</td>
<td>${roi!=null?(roi>=0?`<span class='gain-red'>${(roi*100).toFixed(2)}%</span>`:`<span class='loss-green'>${(roi*100).toFixed(2)}%</span>`):''}</td>
<td>${accGain? (accGain>=0?`<span class='gain-red'>+${accGain}</span>`:`<span class='loss-green'>${accGain}</span>`):''}</td>
<td style="border-left:2px solid #ddd;">${sugg||''}</td><td>${px.toFixed(2)}</td><td>${planFee}</td>
<td>${planBuyAmt.toLocaleString()}</td><td>${planSellAmt.toLocaleString()}</td>
<td>${planGain!=null?(planGain>=0?`<span class='gain-red'>+${planGain}</span>`:`<span class='loss-green'>${planGain}</span>`):''}</td>
<td>${planRoi!=null?(planRoi>=0?`<span class='gain-red'>${(planRoi*100).toFixed(2)}%</span>`:`<span class='loss-green'>${(planRoi*100).toFixed(2)}%</span>`):''}</td>
<td>${planAcc!=null?(planAcc>=0?`<span class='gain-red'>+${planAcc}</span>`:`<span class='loss-green'>${planAcc}</span>`):''}</td>
</tr>`;
});
tbody.innerHTML=rows.join('');
})();
</script>
</body>
</html>
