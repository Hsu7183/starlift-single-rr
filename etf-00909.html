<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ETF 00909｜DipBuy 指標頁（最終重構版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* —— 表格緊湊樣式：縮小字級、內距、行高，避免出框 —— */
    table.compact { font-size: 12px; table-layout: fixed; width: 100%; }
    table.compact th, table.compact td { padding: 4px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .kpi-chip { @apply rounded-xl px-3 py-1 text-sm font-medium border; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .section-card { @apply bg-white shadow-sm rounded-2xl p-4 border; }
    /* sticky tools */
    .toolbox { position: sticky; top: 0; z-index: 20; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <header class="mb-4">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">ETF 00909｜DipBuy 指標頁（最終重構版）</h1>
      <p class="text-sm text-gray-500">遵循「摘要六項」最終重構：緊湊表格／正確買賣欄位／KPI 全顯示／累計損益（含試算）／每筆交易期間同行顯示／一次一列不換行。</p>
    </header>

    <!-- 工具列：檔案、當前價、重算、下載 -->
    <div class="toolbox section-card flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center gap-3">
        <label class="text-sm text-gray-600">匯入交易TXT</label>
        <input id="file" type="file" accept=".txt,.csv" class="block text-sm" />
        <button id="load-demo" class="text-xs border px-2 py-1 rounded-md">載入DEMO</button>
      </div>
      <div class="flex items-center gap-3">
        <label class="text-sm text-gray-600">目前價（手動輸入）</label>
        <input id="curPrice" type="number" step="0.000001" class="border rounded-md px-2 py-1 w-32 text-right mono" placeholder="例如 18.520000" />
        <button id="recalc" class="border px-3 py-1 rounded-md">重算</button>
      </div>
    </div>

    <!-- KPI 區塊 -->
    <section class="mt-4 section-card space-y-3">
      <div class="flex flex-wrap gap-2">
        <span class="kpi-chip" id="kpi-date-range">期間：—</span>
        <span class="kpi-chip" id="kpi-trades">筆數：0</span>
        <span class="kpi-chip" id="kpi-winrate">勝率：—</span>
        <span class="kpi-chip" id="kpi-realized">已實現損益：—</span>
        <span class="kpi-chip" id="kpi-unrealized">損益試算（含庫存）：—</span>
        <span class="kpi-chip" id="kpi-total">累計損益（含試算）：—</span>
      </div>
      <p class="text-xs text-gray-500">說明：勝率以完整一進一出之「回合」統計；損益試算由「目前價」對庫存平均成本估算；累計損益（含試算）＝已實現＋損益試算。</p>
    </section>

    <!-- 交易明細 -->
    <section class="mt-4 section-card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">交易明細</h2>
        <div class="text-xs text-gray-500">規格：每行期間同行顯示；買進僅顯示買價、賣出僅顯示賣價。</div>
      </div>
      <div class="overflow-x-auto">
        <table class="compact border-separate border-spacing-y-0.25">
          <thead>
            <tr class="bg-gray-100 text-gray-700">
              <th class="w-[120px]">時間</th>
              <th class="w-[70px]">動作</th>
              <th class="w-[110px]">買進價</th>
              <th class="w-[110px]">賣出價</th>
              <th class="w-[150px]">交易期間</th>
              <th class="w-[130px]">單筆已實現</th>
              <th class="w-[130px]">累計損益（含試算）</th>
              <th class="w-[260px]">說明</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- 設定與格式說明 -->
    <section class="mt-4 section-card">
      <h2 class="font-semibold mb-2">匯入格式說明（相容兩類）</h2>
      <ol class="list-decimal ml-5 text-sm space-y-1">
        <li>通用「交易紀錄輸出格式」：<span class="mono">YYYYMMDDhhmmss.000000 價格(6位) 動作</span>；動作必為：<span class="mono">新買 / 平賣 / 新賣 / 平買 / 強制平倉</span>。</li>
        <li>ETF 摘要格式（範例）：<span class="mono">20231108,90500,17.860000,賣出,平均成本含稅=17.635000,...,稅後累積獲利=182</span>。系統會自動擷取日期時間、動作（買進/賣出）、成交價與備註。</li>
      </ol>
      <p class="text-xs text-gray-500">若同時存在不同格式，將依行別自動判別解析。</p>
    </section>

    <footer class="py-6 text-center text-xs text-gray-400">© 三劍客量化｜00909 指標頁（最終重構版）</footer>
  </div>

<script>
// ——————————— 小工具：格式轉換與顯示 ———————————
const fmt = {
  num: (v, d=0) => {
    if (v === undefined || v === null || isNaN(v)) return '—';
    return Number(v).toFixed(d);
  },
  p: (v) => (v===undefined||isNaN(v)?'—':(Number(v)*100).toFixed(2)+'%'),
  money: (v) => {
    if (v===undefined||v===null||isNaN(v)) return '—';
    const n = Number(v);
    return (n>=0?'+':'') + n.toLocaleString('zh-Hant', {maximumFractionDigits:0});
  },
  dt: (yyyymmdd, hhmmss) => {
    if (!yyyymmdd) return '—';
    const s = String(yyyymmdd);
    const t = String(hhmmss||'');
    const d = `${s.slice(0,4)}/${s.slice(4,6)}/${s.slice(6,8)}`;
    if (t) return `${d} ${t.slice(0,2)}:${t.slice(2,4)}:${t.slice(4,6)}`;
    return d;
  }
};

function parseLine(line) {
  const raw = line.trim();
  if (!raw) return null;

  // 類型1：通用紀錄：YYYYMMDDhhmmss.000000 價格 動作
  const m1 = raw.match(/^(\d{8})(\d{6})\.\d+\s+(\d+\.\d{6})\s+(新買|平賣|新賣|平買|強制平倉)$/);
  if (m1) {
    const [_, ymd, hms, price, act] = m1;
    return {
      date: ymd, time: hms, price: Number(price),
      action: (act==='新買'?'買進': act==='平賣'?'賣出': act==='新賣'?'做空': act==='平買'?'回補':'強制平倉'),
      note: '標準格式'
    };
  }

  // 類型2：ETF 摘要CSV：YYYYMMDD,hhmmss,price,買進|賣出,備註...
  const parts = raw.split(',');
  if (parts.length >= 4) {
    const [d, t, price, act] = parts;
    if (/^\d{8}$/.test(d) && /^\d{4,6}$/.test(t) && /^\d+\.\d+$/i.test(price) && /(買進|賣出)/.test(act)) {
      return {
        date: d, time: t.padStart(6,'0'), price: Number(price), action: act.includes('買')?'買進':'賣出', note: parts.slice(4).join(',')
      };
    }
  }

  // 其他：忽略
  return null;
}

function computeKpis(rows, curPrice) {
  // 以「多單」邏輯：買進→賣出成一回合；庫存僅計多單，平均成本用加權。
  let realized = 0; // 已實現
  let posQty = 0, posCostSum = 0; // 庫存數量、成本總額
  let rounds = 0, win = 0;
  let minDate=null, maxDate=null;

  const enriched = rows.map((r)=>({ ...r }));
  let cum = 0; // 含試算累積

  for (let i=0;i<enriched.length;i++) {
    const r = enriched[i];

    // 日期範圍
    if (r.date) {
      if (!minDate || r.date < minDate) minDate = r.date;
      if (!maxDate || r.date > maxDate) maxDate = r.date;
    }

    let singleReal = null; // 單筆已實現

    if (r.action === '買進') {
      // 進：平均成本
      posQty += 1;
      posCostSum += r.price;
    } else if (r.action === '賣出') {
      if (posQty > 0) {
        const avg = posCostSum / posQty;
        const pnl = r.price - avg;
        realized += pnl;
        singleReal = pnl;
        rounds += 1;
        if (pnl > 0) win += 1;
        // 清倉（假設每次賣出結束多單部位）
        posQty = 0; posCostSum = 0;
      } else {
        // 無倉賣出，視為忽略或策略外事件
        singleReal = 0;
      }
    }

    // 試算未實現：用目前價對庫存（若有）
    let trial = 0;
    if (posQty > 0 && curPrice) {
      const avg = posCostSum / posQty;
      trial = (curPrice - avg) * posQty;
    }

    cum = realized + trial;

    r._singleReal = singleReal;
    r._cum = cum;
  }

  const winrate = rounds ? (win/rounds) : null;
  let trialEnd = 0;
  if (posQty > 0 && curPrice) trialEnd = curPrice - (posCostSum/posQty);

  return {
    enriched,
    realized,
    unrealized: (posQty>0 && curPrice)? (curPrice - (posCostSum/posQty)) * posQty : 0,
    total: realized + ((posQty>0 && curPrice)? (curPrice - (posCostSum/posQty)) * posQty : 0),
    rounds, win, winrate,
    dateRange: (minDate && maxDate) ? `${minDate.slice(0,4)}/${minDate.slice(4,6)}/${minDate.slice(6,8)} ~ ${maxDate.slice(0,4)}/${maxDate.slice(4,6)}/${maxDate.slice(6,8)}` : '—'
  };
}

function render(rows, curPrice){
  const { enriched, realized, unrealized, total, rounds, win, winrate, dateRange } = computeKpis(rows, curPrice);

  // KPI
  document.getElementById('kpi-date-range').textContent = `期間：${dateRange}`;
  document.getElementById('kpi-trades').textContent = `筆數：${rows.length}`;
  document.getElementById('kpi-winrate').textContent = `勝率：${winrate==null? '—' : (winrate*100).toFixed(1)+'%'}`;
  document.getElementById('kpi-realized').textContent = `已實現損益：${fmt.money(realized)}`;
  document.getElementById('kpi-unrealized').textContent = `損益試算（含庫存）：${fmt.money(unrealized)}`;
  document.getElementById('kpi-total').textContent = `累計損益（含試算）：${fmt.money(total)}`;

  // 表格
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  // 追蹤期間：以最近一次買進到下一次賣出為一段，同行顯示
  let lastBuy = null;

  enriched.forEach((r, idx) => {
    if (r.action === '買進') lastBuy = r; // 標記段落起點

    const tr = document.createElement('tr');
    tr.className = 'bg-white hover:bg-gray-50 border-b';

    const dt = fmt.dt(r.date, r.time);

    const period = (()=>{
      if (r.action === '賣出' && lastBuy) {
        // 買→賣 的期間
        return `${fmt.dt(lastBuy.date, lastBuy.time)} ~ ${fmt.dt(r.date, r.time)}`;
      }
      if (r.action === '買進') {
        // 顯示起點至「目前價」（若尚未賣出）
        return `${fmt.dt(r.date, r.time)} ~ ${curPrice? '至今' : '—'}`;
      }
      return '—';
    })();

    // 買/賣欄位：買進僅顯示買價，賣出僅顯示賣價
    const buyPrice = r.action==='買進' ? fmt.num(r.price, 6) : '';
    const sellPrice = r.action==='賣出' ? fmt.num(r.price, 6) : '';

    tr.innerHTML = `
      <td class="mono text-gray-700">${dt}</td>
      <td class="font-medium ${r.action==='買進'?'text-red-600': r.action==='賣出'?'text-green-600':'text-gray-600'}">${r.action}</td>
      <td class="mono text-right">${buyPrice}</td>
      <td class="mono text-right">${sellPrice}</td>
      <td class="mono">${period}</td>
      <td class="mono text-right">${r._singleReal==null?'':fmt.money(r._singleReal)}</td>
      <td class="mono text-right">${fmt.money(r._cum)}</td>
      <td class="text-xs text-gray-500">${r.note||''}</td>
    `;

    tbody.appendChild(tr);
  });
}

async function readFile(file){
  const text = await file.text();
  const rows = [];
  text.split(/\r?\n/).forEach((line)=>{
    const r = parseLine(line);
    if (r) rows.push(r);
  });
  return rows;
}

// ——————————— 事件繫結 ———————————
let state = { rows: [], curPrice: null };

const $ = (id)=>document.getElementById(id);

$('file').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  state.rows = await readFile(f);
  render(state.rows, state.curPrice);
});

$('recalc').addEventListener('click', ()=>{
  const v = Number($('curPrice').value);
  state.curPrice = isNaN(v) ? null : v;
  render(state.rows, state.curPrice);
});

$('load-demo').addEventListener('click', ()=>{
  const demo = [
    '20231107,90500,17.610000,買進,層=1,今開=17.620000,昨收=17.880000,門檻%=1.20,成本含稅=17.635000,本次單位=1,總單位=1',
    '20231108,90500,17.860000,賣出,平均成本含稅=17.635000,買價=17.64,賣價=17.86,毛利=225,買手續費=25,賣手續費=25,交易稅=18,稅後獲利=182,稅後累積獲利=182,總單位=1',
    '20231122,90500,18.410000,買進,層=1,今開=18.440000,昨收=18.670000,門檻%=1.20,成本含稅=18.430000,本次單位=1,總單位=1'
  ];
  state.rows = demo.map(parseLine).filter(Boolean);
  state.curPrice = 18.520000;
  $('curPrice').value = state.curPrice;
  render(state.rows, state.curPrice);
});

// 初始：空畫面
render([], null);
</script>
</body>
</html>
