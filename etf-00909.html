<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>00909-ETF版本｜機構級 KPI</title>
<style>
  :root{ --wrap:1100px; --r:12px; }
  body{
    font-family:Arial,"微軟正黑體",sans-serif;
    font-variant-numeric: tabular-nums;
    margin:20px; background:#f8f9fa; color:#333;
  }
  h1{ margin:0 0 6px 0; font-weight:800; letter-spacing:.5px; }
  .sub{ color:#666; margin:0 0 18px 0; font-size:14px; }
  .wrap{ max-width:var(--wrap); margin:0 auto; }
  .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .home{ display:inline-block; padding:6px 10px; border-radius:10px; border:1px solid #aaa; color:#333; text-decoration:none; font-size:12px; }
  .home:hover{ background:#f2f2f2; }

  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:var(--r); box-shadow:0 2px 8px rgba(0,0,0,.06); padding:16px 18px; margin:14px 0; }
  .meta{ color:#666; font-size:12px; }
  .btn{ display:inline-block; padding:6px 10px; border-radius:10px; border:1px solid #0d6efd; color:#0d6efd; text-decoration:none; font-size:12px; }
  .btn.secondary{ border-color:#aaa; color:#555; }

  .kpi-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
  .kpi{ background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px 12px; }
  .kpi .t{ font-size:12px; color:#666; margin:0; }
  .kpi .v{ font-size:20px; font-weight:800; margin:4px 0 0; color:#111; }
  .kpi .v.green{ color:#10b981; }
  .kpi .v.red{   color:#d32f2f; }
  .kpi .v.muted{ color:#666; }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .chartbox{ height:340px; }
  canvas{ width:100%; height:100%; background:#fff; border:1px solid #eee; border-radius:10px; }

  /* ====== 交易明細：固定欄寬、不換行、與卡片對齊（不置中、無右白邊） ====== */
  .tablecard{ padding:16px 18px; }              /* 與其他卡片一致的左右 padding */
  .table-wrap{ width:100%; overflow-x:auto; }   /* 超出可橫向捲動，貼齊左側 */
  .simple-table{
    table-layout:fixed !important;
    width:1802px;                               /* 等於 colgroup 總寬 */
    border-collapse:collapse;
    font-size:11px;
    font-variant-numeric: tabular-nums;
  }
  .simple-table th,.simple-table td{
    box-sizing:border-box;
    padding:4px 6px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    border-bottom:1px solid #eee;
    text-align:right;
  }
  .simple-table th:first-child,.simple-table td:first-child{ text-align:left; }
  .simple-table tr{ background-clip:padding-box; }
  .row-buy{  background:#fdecea; }
  .row-sell{ background:#e9f8ef; }
  .gain-red{ color:#d32f2f; font-weight:600; }
  .loss-green{ color:#10b981; font-weight:600; }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1 style="margin-right:auto;">00909-ETF版本｜機構級 KPI</h1>
    <a class="home" href="index.html">← 回首頁</a>
  </div>
  <p class="sub">資料：Supabase <code>/reports</code> 最新「00909」TXT；股票線獨立計算（不動期貨線）。</p>

  <div class="card">
    <div class="toolbar">
      <div id="meta" class="meta">正在抓取最新檔案…</div>
      <span style="flex:1;"></span>
      <a id="rawlink" class="btn" href="#" target="_blank" style="display:none;">查看原始 TXT</a>
      <a id="dl-raw"  class="btn secondary" href="#" download="00909_raw.txt" style="display:none;">下載原始 TXT</a>
    </div>
  </div>

  <!-- KPI 區 -->
  <div class="card"><h3>核心績效（Performance）</h3><div id="kpi-core" class="kpi-grid"></div></div>
  <div class="card"><h3>風險（Risk）</h3><div id="kpi-risk" class="kpi-grid"></div></div>
  <div class="card"><h3>風險調整後報酬（Risk-Adjusted）</h3><div id="kpi-ra" class="kpi-grid"></div></div>
  <div class="card"><h3>下行風險（Downside Risk）</h3><div id="kpi-down" class="kpi-grid"></div></div>
  <div class="card"><h3>交易品質（Trade Quality）</h3><div id="kpi-trade" class="kpi-grid"></div></div>
  <div class="card"><h3>執行品質（Execution Quality）</h3><div id="kpi-exe" class="kpi-grid"></div></div>
  <div class="card"><h3>穩健性（Stability / Robustness）</h3><div id="kpi-stab" class="kpi-grid"></div></div>
  <div class="card"><h3>資金效率（Capital Efficiency）</h3><div id="kpi-capital" class="kpi-grid"></div></div>
  <div class="card"><h3>容量與流動性（Capacity & Liquidity）</h3><div id="kpi-cap" class="kpi-grid"></div></div>
  <div class="card"><h3>延伸統計（Extended Stats）</h3><div id="kpi-ext" class="kpi-grid"></div></div>

  <!-- 圖表 -->
  <div class="card"><h3>收益曲線（每百萬 %）</h3><div class="chartbox"><canvas id="eq"></canvas></div></div>
  <div class="card grid2">
    <div><h3>MAE vs MFE（散點，％）</h3><div class="chartbox"><canvas id="maeMfe"></canvas></div></div>
    <div><h3>ISbps 分佈（直方）</h3><div class="chartbox"><canvas id="isHist"></canvas></div></div>
  </div>
</div>

<!-- 交易明細（與上方卡片同寬、貼齊） -->
<div class="card tablecard">
  <h3>交易明細</h3>
  <div class="table-wrap">
    <table class="simple-table" id="tblTrade">
      <colgroup>
        <col style="width:50px;"><!-- 筆數 -->
        <col style="width:64px;"><!-- 股票名稱 -->
        <col style="width:124px;"><!-- 成交日+時間 -->
        <col style="width:56px;"><!-- 種類 -->
        <col style="width:86px;"><!-- 交易數量 -->
        <col style="width:64px;"><!-- 單價 -->
        <col style="width:64px;"><!-- 手續費 -->
        <col style="width:110px;"><!-- 買進金額 -->
        <col style="width:110px;"><!-- 賣出金額 -->
        <col style="width:96px;"><!-- 損益 -->
        <col style="width:72px;"><!-- 獲利率 -->
        <col style="width:120px;"><!-- 累計損益 -->
        <col style="width:110px;"><!-- 建議交易數量(股) -->
        <col style="width:64px;"><!-- 單價 -->
        <col style="width:90px;"><!-- 手續費(估) -->
        <col style="width:120px;"><!-- 買進金額(估) -->
        <col style="width:120px;"><!-- 賣出金額(估) -->
        <col style="width:110px;"><!-- 損益試算 -->
        <col style="width:72px;"><!-- 獲利率(試) -->
        <col style="width:140px;"><!-- 累計損益(含試算) -->
      </colgroup>
      <thead>
        <tr>
          <th>筆數</th><th>股票名稱</th><th>成交日</th><th>種類</th><th>交易數量</th><th>單價</th><th>手續費</th>
          <th>買進金額</th><th>賣出金額</th>
          <th>損益</th><th>獲利率</th><th>累計損益</th>
          <th style="border-left:2px solid #ddd;">建議交易數量(股)</th><th>單價</th><th>手續費(估)</th>
          <th>買進金額(估)</th><th>賣出金額(估)</th>
          <th>損益試算</th><th>獲利率</th><th>累計損益(含試算)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- 依賴 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="etf-engine.js"></script>
<script src="etf-chart.js"></script>

<script>
(async function(){
  /* ===== Supabase 設定 ===== */
  const SUPABASE_URL = "https://byhbmmnacezzgkwfkozs.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_xVe8fGbqQ0XGwi4DsmjPMg_Y2RBOD3t";
  const BUCKET = "reports";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    global: { fetch: (u,o={}) => fetch(u,{...o, cache:'no-store'}) }
  });

  const metaEl = document.getElementById('meta');
  const rawLink = document.getElementById('rawlink');
  const dlRaw  = document.getElementById('dl-raw');

  function pubUrl(p){ const { data } = sb.storage.from(BUCKET).getPublicUrl(p); return data?.publicUrl || '#'; }
  async function latest00909(){
    const { data, error } = await sb.storage.from(BUCKET).list('', { limit:1000, sortBy:{ column:'name', order:'asc' }});
    if (error) throw error;
    const files = (data||[]).filter(it => /00909/i.test(it.name));
    if(!files.length) return null;
    files.sort((a,b)=> b.name.localeCompare(a.name));
    return files[0];
  }

  // 智慧解碼
  async function fetchSmart(url){
    const buf = await fetch(url,{cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.arrayBuffer(); });
    const encs = ['utf-8','big5','utf-16le','utf-16be'];
    for(const enc of encs){
      try{
        const td=new TextDecoder(enc,{fatal:false});
        const txt=td.decode(buf);
        const parsed=ETFEngine.parseEtfTxt(txt);
        if(parsed && parsed.trades && parsed.trades.length>0) return {txt,enc,parsed};
      }catch(e){}
    }
    const txt=new TextDecoder('utf-8').decode(buf);
    return {txt,enc:'utf-8',parsed:ETFEngine.parseEtfTxt(txt)};
  }

  // KPI 渲染（profit=紅、down=值越大越紅）
  function putKPIs(id, items){
    const el=document.getElementById(id); el.innerHTML='';
    items.forEach(k=>{
      const d=document.createElement('div'); d.className='kpi';
      const t=document.createElement('p'); t.className='t'; t.textContent=k.label;
      const v=document.createElement('p'); v.className='v'; v.textContent=k.fmt(k.value);
      if(typeof k.value==='number'){
        if(k.pos==='profit'){ v.classList.add(k.value>0?'red':(k.value<0?'green':'muted')); }
        else if(k.pos==='up'){ v.classList.add(k.value>0?'green':(k.value<0?'red':'muted')); }
        else if(k.pos==='down'){ v.classList.add(k.value<0?'green':(k.value>0?'red':'muted')); }
        else v.classList.add('muted');
      }else v.classList.add('muted');
      d.appendChild(t); d.appendChild(v); el.appendChild(d);
    });
  }
  const pct=x=>(x==null||!isFinite(x)?'—':(x*100).toFixed(2)+'%');
  const num=x=>(x==null||!isFinite(x)?'—':(+x).toFixed(2));
  const int=x=>(x==null||!isFinite(x)?'—':Math.round(+x).toString());

  // 依法：手續費單邊 0.1425%（最低20）；ETF 證交稅 0.1%（賣出）
  const FEE_RATE=ETFEngine.FEE_RATE||0.001425, FEE_MIN=ETFEngine.FEE_MIN||20, TAX_RATE=ETFEngine.TAX_RATE||0.001;
  const fee = amt => Math.max(Math.round(amt*FEE_RATE), FEE_MIN);
  const taxOnSell = amt => Math.round(amt*TAX_RATE);

  try{
    metaEl.textContent='正在抓取最新 00909 檔…';
    const latest=await latest00909();
    if(!latest){ metaEl.textContent='⚠️ 沒找到 00909 檔案。'; return; }
    const rawUrl=pubUrl(latest.name); rawLink.style.display='inline-block'; rawLink.href=rawUrl;

    const {txt:rawTxt,enc,parsed}=await fetchSmart(rawUrl);
    const blob=new Blob([rawTxt],{type:'text/plain'});
    dlRaw.style.display='inline-block';
    dlRaw.href=URL.createObjectURL(blob);
    dlRaw.download = latest.name || '00909_raw.txt';

    const first=parsed.days[0]? `${parsed.days[0].slice(0,4)}/${parsed.days[0].slice(4,6)}/${parsed.days[0].slice(6,8)}` : '—';
    const lastFmt = parsed.days.length? `${parsed.days.at(-1).slice(0,4)}/${parsed.days.at(-1).slice(4,6)}/${parsed.days.at(-1).slice(6,8)}` : '—';
    metaEl.textContent=`✅ 已載入：${latest.name}（解碼：${enc}）｜交易筆數=${parsed.trades.length}｜期間：${first} ~ ${lastFmt}`;

    // 由引擎取得基礎 KPI
    const k = ETFEngine.calcEtfKpis(parsed);

    // ===== 進一步在頁面端推算的機構級指標 =====
    const rets = parsed.rets || [];
    const mean=a=>a.length? a.reduce((s,v)=>s+v,0)/a.length : 0;
    const std=(a)=>{ if(a.length<2) return 0; const m=mean(a); let s=0; for(const v of a){ const d=v-m; s+=d*d; } return Math.sqrt(s/(a.length-1)); };
    const downsideDev=(rets)=>{ const neg=rets.map(r=>Math.min(0,r)); if(!neg.length) return 0; const m=mean(neg); let s=0; for(const v of neg){ const d=v-m; s+=d*d; } return Math.sqrt(s/(neg.length-1)) * Math.sqrt(252); };
    const meanDaily = mean(rets);
    const annMean = meanDaily*252;
    const MAR = k.risk.MDD>0 ? ( (k.core.CAGR!=null?k.core.CAGR:annMean) / k.risk.MDD ) : null;

    const gains = parsed.trades.map(t=>t.gainSlip).filter(v=>v!=null);
    const wins  = gains.filter(v=>v>0);
    const losses= gains.filter(v=>v<0).map(v=>-v);
    const expectancy = gains.length? gains.reduce((s,v)=>s+v,0)/gains.length : 0;
    const expectancyPct = expectancy/ETFEngine.BASE_CAP;
    const omega = (()=>{ const pos=rets.filter(x=>x>0), neg=rets.filter(x=>x<0).map(x=>-x); const sPos=pos.reduce((s,v)=>s+v,0), sNeg=neg.reduce((s,v)=>s+v,0); return sNeg>0? sPos/sNeg : null; })();

    // ===== 渲染 KPI =====
    putKPIs('kpi-core', [
      {label:'累積報酬（每百萬）', value:k.core.totalReturn, fmt:pct, pos:'profit'},
      {label:'年化報酬 CAGR',    value:k.core.CAGR,        fmt:pct, pos:'profit'},
      {label:'涵蓋日數',         value:k.core.coverDays,   fmt:int, pos:null},
      {label:'交易筆數',         value:k.core.trades,      fmt:int, pos:null},
    ]);

    putKPIs('kpi-risk', [
      {label:'年化波動', value:k.risk.volAnn, fmt:pct, pos:'down'},
      {label:'最大回撤', value:k.risk.MDD,    fmt:pct, pos:'down'},
      {label:'回撤持續（日）', value:k.risk.ddDuration, fmt:int, pos:null},
      {label:'Ulcer Index', value:(k.risk.UlcerIndex/100), fmt:pct, pos:'down'},
    ]);

    putKPIs('kpi-ra', [
      {label:'Sharpe',  value:k.risk.Sharpe,  fmt:num, pos:'profit'},
      {label:'Sortino', value:k.risk.Sortino, fmt:num, pos:'profit'},
      {label:'Calmar',  value:k.risk.Calmar,  fmt:num, pos:'profit'},
      {label:'MAR (CAGR/MDD)', value:MAR,     fmt:num, pos:'profit'},
      {label:'Omega',   value:omega,          fmt:num, pos:'profit'},
    ]);

    putKPIs('kpi-down', [
      {label:'VaR(95%) / 日',  value:k.risk.VaR95,  fmt:pct, pos:'down'},
      {label:'CVaR(95%) / 日', value:k.risk.CVaR95, fmt:pct, pos:'down'},
      {label:'Downside Deviation(年化)', value:downsideDev(rets), fmt:pct, pos:'down'},
    ]);

    putKPIs('kpi-trade', [
      {label:'勝率',           value:k.trade.winRate,   fmt:pct, pos:'profit'},
      {label:'Profit Factor',  value:k.trade.PF,        fmt:num, pos:'profit'},
      {label:'期望值/筆（百萬）',  value:expectancyPct,   fmt:pct, pos:'profit'},
      {label:'均單報酬（每筆/百萬）', value:k.trade.avgTrade, fmt:pct, pos:'profit'},
      {label:'平均持有(分)',   value:k.trade.avgHoldMin, fmt:int, pos:null},
      {label:'中位持有(分)',   value:k.trade.medHoldMin, fmt:int, pos:null},
      {label:'平均 MAE',       value:k.trade.avgMAEpct/100, fmt:pct, pos:'down'},
      {label:'平均 MFE',       value:k.trade.avgMFEpct/100, fmt:pct, pos:'profit'},
    ]);

    putKPIs('kpi-exe', [
      {label:'平均 ISbps', value:k.trade.avgISbps, fmt:num, pos:'down'},
    ]);

    putKPIs('kpi-stab', [
      {label:'Beta', value:null, fmt:()=> '—', pos:null},
      {label:'Alpha', value:null, fmt:()=> '—', pos:'profit'},
      {label:'R²', value:null, fmt:()=> '—', pos:'up'},
    ]);

    putKPIs('kpi-capital', [
      {label:'預估槓桿', value:null, fmt:()=> '—', pos:'down'},
      {label:'平均曝險', value:null, fmt:()=> '—', pos:'down'},
    ]);

    putKPIs('kpi-cap', [
      {label:'平均參與率',  value:k.capacity?.avgParticipation ?? 0, fmt:pct, pos:'down'},
      {label:'P75 參與率',  value:k.capacity?.p75Participation ?? 0, fmt:pct, pos:'down'},
    ]);

    putKPIs('kpi-ext', [
      {label:'年化均值', value:annMean, fmt:pct, pos:'profit'},
      {label:'年化波動(頁端計)', value:std(rets)*Math.sqrt(252), fmt:pct, pos:'down'},
    ]);

    // ===== 圖表 =====
    ETFChart.drawEquityCurve(
      document.getElementById('eq'),
      parsed.days.map(d=>`${d.slice(0,4)}/${d.slice(4,6)}/${d.slice(6,8)}`),
      parsed.equity
    );
    {
      const pairs = parsed.trades
        .filter(t => t.maePct != null && t.mfePct != null)
        .map(t => ({ x: t.maePct, y: t.mfePct }));
      ETFChart.drawMaeMfeScatter(document.getElementById('maeMfe'), pairs);
    }
    ETFChart.drawIsHist(
      document.getElementById('isHist'),
      parsed.trades.map(t=>t.ISbps).filter(v=>v!=null),
      24
    );

    // ===== 交易明細 =====
    const tbody=document.querySelector('#tblTrade tbody');
    const CAPITAL=1_000_000;

    const tradeByTid={}; parsed.trades.forEach(t=> tradeByTid[String(t.tid)]=t);
    const baseUnitLotsByTid={};   // ★ 每個 tid 的「基準單位張數」
    const suggLotsSumByTid={};    // ★ 每個 tid 目前累計的建議買進張數（供 SELL 列使用）
    let accGain=0, cumWithPlan=0;

    const rows = parsed.events
      .filter(e=>['BUY','ADD1','ADD2','SELL'].includes(e.action))
      .sort((a,b)=> a.ts.localeCompare(b.ts))
      .map((e,idx)=>{
        const isSell=(e.action==='SELL');
        const cls=isSell? 'row-sell':'row-buy';
        const px=+e.price||0;
        const tid=e.kv.tid;

        // 原始交易量
        const lotsRaw = e.kv.lotsThisRow || 0;
        const sharesRaw = lotsRaw*1000;
        const grossRaw  = px*sharesRaw;

        // 手續費（單邊）；賣出金額包含手續費與證交稅（0.1%）
        const feeRaw = Math.max(Math.round(grossRaw*FEE_RATE), 20);
        const buyAmt = !isSell? Math.round(grossRaw + feeRaw) : null;
        const sellAmt=  isSell? Math.round(grossRaw - feeRaw - Math.round(grossRaw*TAX_RATE)) : null;

        // 實際損益 / 獲利率（損益 ÷ 1,000,000）
        let gain=null, roi=null, accHtml='';
        if(isSell){
          const tr=tradeByTid[tid];
          gain = Math.round(tr?.gainSlip ?? 0);
          roi  = gain / 1_000_000;
          accGain += gain;
          accHtml = accGain>0? `<span class="gain-red">+${accGain.toLocaleString()}</span>` :
                    accGain<0? `<span class="loss-green">${accGain.toLocaleString()}</span>` : '';
        }

        // ===== 建議交易數量(股)：同 tid 固定 1-1-2 倍，基準＝第一筆 BUY 的實際張數 =====
        if(!baseUnitLotsByTid[tid]){
          // 若第一列是 BUY/ADD 之一，直接以「實際張數」做為基準；若遇到資料缺漏，再以資金推導一個基準
          baseUnitLotsByTid[tid] = (e.action==='BUY'||e.action==='ADD1'||e.action==='ADD2') && lotsRaw>0
            ? lotsRaw
            : (function fallback(){
                const oneLot = Math.round(px*1000 + Math.max(Math.round(px*1000*FEE_RATE),20));
                const maxLots = oneLot>0? Math.floor(CAPITAL/oneLot) : 0;
                return Math.max(1, Math.floor(maxLots/4));   // 最小 1 張
              })();
        }
        const baseLots = baseUnitLotsByTid[tid];

        let suggLots = 0;
        if(e.action==='BUY' || e.action==='ADD1') suggLots = baseLots;
        else if(e.action==='ADD2')               suggLots = baseLots*2;
        else if(e.action==='SELL')               suggLots = (suggLotsSumByTid[tid]||0);

        if(!isSell) suggLotsSumByTid[tid]=(suggLotsSumByTid[tid]||0)+suggLots;

        const sharesSugg = (suggLots||0)*1000;

        // 試算（賣列顯示）
        const tr=tradeByTid[tid];
        const pxInAvg=tr?.pxInAvg ?? px;
        const grossBuyAvg=pxInAvg*sharesSugg;
        const feeBuyAvg=Math.max(Math.round(grossBuyAvg*FEE_RATE),20);
        const buyNetAvg=Math.round(grossBuyAvg + feeBuyAvg);

        const grossSellEst=px*sharesSugg;
        const feeSellEst=Math.max(Math.round(grossSellEst*FEE_RATE),20);
        const taxEst=Math.round(grossSellEst*TAX_RATE);
        const sellNetEst=Math.round(grossSellEst - feeSellEst - taxEst);

        let planGain=null, planRoi=null, showCumPlan='';
        if(isSell){
          planGain = sellNetEst - buyNetAvg;
          planRoi  = planGain / 1_000_000;
          cumWithPlan += (planGain||0);
          showCumPlan = cumWithPlan>0? `<span class="gain-red">+${cumWithPlan.toLocaleString()}</span>` :
                        cumWithPlan<0? `<span class="loss-green">${cumWithPlan.toLocaleString()}</span>` : '';
        }

        // 成交日顯示：YYYY/MM/DD hh:mm
        const d8 = `${e.d8.slice(0,4)}/${e.d8.slice(4,6)}/${e.d8.slice(6,8)}`;
        const hhmm = `${e.t6.slice(0,2)}:${e.t6.slice(2,4)}`;
        const dateTime = `${d8} ${hhmm}`;

        const money=v=> (v==null||v===0)? '' : (v>0? `<span class="gain-red">+${v.toLocaleString()}</span>` : `<span class="loss-green">${v.toLocaleString()}</span>`);
        const rate=v=> (v==null)? '' : (v>=0? `<span class="gain-red">${(v*100).toFixed(2)}%</span>` : `<span class="loss-green">${(v*100).toFixed(2)}%</span>`);

        return `<tr class="${cls}">
          <td>${idx+1}</td>
          <td>00909</td>
          <td>${dateTime}</td>
          <td>${isSell?'賣出':'買進'}</td>
          <td>${sharesRaw? sharesRaw.toLocaleString(): ''}</td>
          <td>${px.toFixed(2)}</td>
          <td>${feeRaw ? feeRaw.toLocaleString(): ''}</td>
          <td>${!isSell && buyAmt!=null? buyAmt.toLocaleString(): ''}</td>
          <td>${ isSell && sellAmt!=null? sellAmt.toLocaleString(): ''}</td>
          <td>${money(gain)}</td>
          <td>${rate(roi)}</td>
          <td>${accHtml}</td>
          <td style="border-left:2px solid #ddd;">${sharesSugg? sharesSugg.toLocaleString(): ''}</td>
          <td>${px? px.toFixed(2): ''}</td>
          <td>${ isSell ? (sharesSugg? feeSellEst.toLocaleString(): '') : (sharesSugg? Math.max(Math.round((px*sharesSugg)*FEE_RATE),20).toLocaleString(): '') }</td>
          <td>${!isSell && sharesSugg? Math.round(px*sharesSugg + Math.max(Math.round((px*sharesSugg)*FEE_RATE),20)).toLocaleString(): ''}</td>
          <td>${ isSell && sharesSugg? sellNetEst.toLocaleString(): ''}</td>
          <td>${money(planGain)}</td>
          <td>${rate(planRoi)}</td>
          <td>${showCumPlan}</td>
        </tr>`;
      });

    tbody.innerHTML = rows.join('') || '<tr><td colspan="20" style="text-align:center;color:#777;">（無資料）</td></tr>';

  }catch(err){
    metaEl.textContent='❌ 載入或解析失敗：'+(err?.message||err);
    console.error(err);
  }
})();
</script>
</body>
</html>
